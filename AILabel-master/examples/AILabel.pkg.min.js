!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.AILabel=e()}(this,function(){"use strict";var n,o=function(){};n=!1,o.extend=function(t){var i=null;function e(){n||(i&&(this._superprototype=i.prototype),this.init.apply(this,arguments))}for(var r in this!==o&&(i=this),i&&(n=!0,(e.prototype=new i).constructor=e,n=!1),e.extend=o.extend,t)t.hasOwnProperty(r)&&(e.prototype[r]=i&&"function"==typeof t[r]&&"function"==typeof e.prototype[r]&&/\b_super\b/.test(t[r])?function(t,e){return function(){return this._super=i.prototype[t],e.apply(this,arguments)}}(r,t[r]):t[r]);return e};var D={};function s(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=[],r=!0,n=!1,o=void 0;try{for(var s,a=t[Symbol.iterator]();!(r=(s=a.next()).done)&&(i.push(s.value),!e||i.length!==e);r=!0);}catch(t){n=!0,o=t}finally{try{r||null==a.return||a.return()}finally{if(n)throw o}}return i}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function i(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function r(t,e){var i=[],r=!0,n=!1,o=void 0;try{for(var s,a=t[Symbol.iterator]();!(r=(s=a.next()).done)&&(i.push(s.value),!e||i.length!==e);r=!0);}catch(t){n=!0,o=t}finally{try{r||null==a.return||a.return()}finally{if(n)throw o}}return i}function a(t){if(Array.isArray(t))return t}function L(t){return function(t){if(Array.isArray(t)){for(var e=0,i=new Array(t.length);e<t.length;e++)i[e]=t[e];return i}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function e(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function l(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}function h(t){if(Array.isArray(t)){for(var e=0,i=new Array(t.length);e<t.length;e++)i[e]=t[e];return i}}function c(t,e){var i=(t[0].x-e[0].x)*(t[1].y-e[0].y)-(t[0].y-e[0].y)*(t[1].x-e[0].x),r=(t[0].x-e[1].x)*(t[1].y-e[1].y)-(t[0].y-e[1].y)*(t[1].x-e[1].x);if(0<=i*r)return!1;var n=(e[0].x-t[0].x)*(e[1].y-t[0].y)-(e[0].y-t[0].y)*(e[1].x-t[0].x);return!(0<=n*(n+i-r))}function u(t,e){var i,r,n=e.length,o=0,s=t;i=e[0];for(var a=1;a<=n;++a){if(s.x===i.x&&s.y===i.y)return!0;if(r=e[a%n],s.y<Math.min(i.y,r.y)||s.y>Math.max(i.y,r.y))i=r;else{if(s.y>Math.min(i.y,r.y)&&s.y<Math.max(i.y,r.y)){if(s.x<=Math.max(i.x,r.x)){if(i.y===r.y&&s.x>=Math.min(i.x,r.x))return!0;if(i.x===r.x){if(i.x===s.x)return!0;++o}else{var l=(s.y-i.y)*(r.x-i.x)/(r.y-i.y)+i.x;if(Math.abs(s.x-l)<2e-10)return!0;s.x<l&&++o}}}else if(s.y===r.y&&s.x<=r.x){var h=e[(a+1)%n];s.y>=Math.min(i.y,h.y)&&s.y<=Math.max(i.y,h.y)?++o:o+=2}i=r}}return o%2!=0}function L(t){return h(t)||l(t)||e()}function e(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function l(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}function h(t){if(Array.isArray(t)){for(var e=0,i=new Array(t.length);e<t.length;e++)i[e]=t[e];return i}}function F(t,e,i){var r=t.activeFeature,n=t.activePoint,o=r.points[n.relationNodesIndex[0]],s=r.points[n.relationNodesIndex[1]],a=Math.sqrt((o.x-s.x)*(o.x-s.x)+(o.y-s.y)*(o.y-s.y)),l=(o.y-s.y)/a,h=(o.x-s.x)/a;return 1===l&&0===h||-1===l&&0===h?{dltx:e,dlty:0}:0===l&&1===h||0===l&&-1===h?{dltx:0,dlty:i}:{dltx:0,dlty:0}}function z(t){var e=t.activeFeature,i=t.activePoint,r=e.points[i.relationNodesIndex[0]],n=e.points[i.index],o=Math.sqrt((r.x-n.x)*(r.x-n.x)+(r.y-n.y)*(r.y-n.y)),s=(r.y-n.y)/o,a=(r.x-n.x)/o;return 0===s&&1===a||0===s&&-1===a?{flag:"y"}:{flag:"x"}}function s(t,e){return a(t)||r(t,e)||i()}function i(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function r(t,e){var i=[],r=true,n=false,o=undefined;try{for(var s=t[Symbol.iterator](),a;!(r=(a=s.next()).done);r=true){i.push(a.value);if(e&&i.length===e)break}}catch(t){n=true;o=t}finally{try{if(!r&&s["return"]!=null)s["return"]()}finally{if(n)throw o}}return i}function a(t){if(Array.isArray(t))return t}function L(t){return h(t)||l(t)||e()}function e(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function l(t){if(Symbol.iterator in Object(t)||Object.prototype.toString.call(t)==="[object Arguments]")return Array.from(t)}function h(t){if(Array.isArray(t)){for(var e=0,i=new Array(t.length);e<t.length;e++){i[e]=t[e]}return i}}return D.config={version:"4.0.3",dpr:window.devicePixelRatio||1},D.constants={textureIcon:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAAAXNSR0IArs4c6QAAAHZJREFUKBVj/P//vy8DGvg+f77K1ylTmv7/+cODLMWmr7+SCVkAxManmH/RoqUoGggpBhkI10CMYrgGYhWDNZCiGKSB8bWR0WdsoQHyIEgBMgAZzkSKYlBQwz0NMgkUzrhMhsULXAMxikGGgjUQqxisgRTFIA0AbBWFDBQtKoQAAAAASUVORK5CYII="},D.Util={},D.Util.createDiv=function(t,e,i,r){var n=document.createElement("div");return n.id=t,(e||0===e)&&(n.style.width=e+"px"),(i||0===i)&&(n.style.height=i+"px"),r&&(n.style.position="absolute"),n.style.zIndex=1,n},D.Util.createSvg=function(t,e,i,r){var n=document.createElementNS("http://www.w3.org/2000/svg","svg");return n.id=t,(e||0===e)&&(n.setAttribute("width",e+"px"),n.style.width=e+"px"),(i||0===i)&&(n.setAttribute("height",i+"px"),n.style.height=i+"px"),r&&(n.style.position="absolute"),n.style.zIndex=1,n.setAttribute("version","1.1"),n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n},D.Util.getDpr=function(){return D.config.dpr},D.Util.createCanvas=function(t,e,i,r){var n=document.createElement("canvas"),o=D.Util.getDpr();return n.id=t,n.width=e*o,n.height=i*o,n.style.width=e+"px",n.style.height=i+"px",r&&(n.style.position="absolute"),n},D.Util.transformScreenXYWithDpr=function(t){var e=D.Util.getDpr();return{x:t.x*e,y:t.y*e}},D.Util.isInArray=function(t,e){for(var i in t)if(t[i]===e)return!0;return!1},D.Util.isObjInArray=function(t,e){for(var i in t)if(t[i].id===e.id)return alert("已被添加，请更换图层id"+e.id),!0;return!1},D.Util.setStyle=function(t,e){var i=D.Util.getDpr();return t.fillStyle=e.fillColor,t.strokeStyle=e.strokeColor,t.lineWidth=e.lineWeight*i,t.globalAlpha=e.opacity,t.lineCap="round",t.lineJoin="round",!0},D.Util.worldToScreen=function(t,e,i){var r=t.getCenter(),n=r.x,o=r.y,s=parseInt(t.w,10)/2,a=parseInt(t.h,10)/2,l=t.zoom/parseInt(t.w,10);return{x:parseFloat(s)+parseFloat((e-n)/l)+0,y:parseFloat(a)-parseFloat((i-o)/l)+0}},D.Util.worldToScreenSize=function(t,e,i){var r=t.zoom/parseInt(t.w,10);return{w:parseFloat(e/r),h:parseFloat(i/r)}},D.Util.screenToWorldDistance=function(t,e){var i=t.zoom/parseInt(t.w,10);return parseFloat((e*i).toFixed(4))},D.Util.worldToScreenDistance=function(t,e){var i=t.zoom/parseInt(t.w,10);return parseFloat((e/i).toFixed(4))},D.Util.screenToWorld=function(t,e,i){var r=t.getCenter(),n=r.x,o=r.y,s=parseInt(t.w,10)/2,a=parseInt(t.h,10)/2,l=t.zoom/parseInt(t.w,10),h=parseFloat(n)+parseFloat((e-s)*l),c=parseFloat(o)-parseFloat((i-a)*l);return{x:parseFloat(h.toFixed(4)),y:parseFloat(c.toFixed(4))}},D.Util.addEvtHandler=function(t,e,i){t["on"+e]=i,"mousewheel"===e&&0===D.Util.getIEVersion()&&t.addEventListener("DOMMouseScroll",i,!1)},D.Util.removeEvtHandler=function(t,e){t["on"+e]=null},D.Util.createEventRegister=function(){return window.addEventListener?function(t,e,i){t.addEventListener(e,i)}:window.attachEvent?function(t,e,i){t.attachEvent("on"+e,function(){i.call(t,window.event)})}:function(t,e,i){t["on"+e]=i}},D.Util.createEventCancel=function(){return window.addEventListener?function(t,e,i){t.removeEventListener(e,i,!1)}:window.attachEvent?function(t,e,i){t.detachEvent("on"+e,function(){i.call(t,window.event)})}:function(t,e,i){t["on"+e]=null}},D.Util.addEvtHandlerBAK2=D.Util.createEventRegister(),D.Util.removeEvtHandlerBAK2=D.Util.createEventCancel(),D.Util.getMouseXY=function(t,e){var i=0,r=0,n=e.srcElement?e.srcElement:e.target;if(1!==n.nodeType)return{x:i,y:r};if(document.attachEvent){var o="medium"===D.Util.getEleStyle(n,"border-top-width")?0:D.Util.delpx(D.Util.getEleStyle(n,"border-top-width")),s="medium"===D.Util.getEleStyle(n,"border-left-width")?0:D.Util.delpx(D.Util.getEleStyle(n,"border-left-width"));i=e.layerX-s,r=e.layerY-o}else{for(;n&&n!==t;){var a="medium"===D.Util.getEleStyle(n,"border-top-width")?0:D.Util.delpx(D.Util.getEleStyle(n,"border-top-width")),l="medium"===D.Util.getEleStyle(n,"border-left-width")?0:D.Util.delpx(D.Util.getEleStyle(n,"border-left-width"));i+=n.offsetLeft+l,r+=n.offsetTop+a,n=n.offsetParent}i=e.offsetX+i+document.body.scrollLeft,r=e.offsetY+r+document.body.scrollTop}return{x:i,y:r}},D.Util.getMousePos=function(t){var e=t||window.event;return{x:e.screenX,y:e.screenY}},D.Util.getEleStyle=function(t,e){var i=e.split("-"),r=i[0];if(1<r.length)for(var n=1;n<i.length;n++)r+=i[n].substring(0,1).toUpperCase()+i[n].substring(1);else r=e;return t.currentStyle?t.currentStyle[r]:document.defaultView.getComputedStyle(t,!1)[r]},D.Util.delpx=function(t){return t?parseInt(t.substring(0,t.length-2),10):0},D.Util.getRectPointsWithSAndE=function(t,e){var i=e.x,r=t.y,n=t.x,o=e.y;return[{x:t.x,y:t.y},{x:i,y:r},{x:e.x,y:e.y},{x:n,y:o}]},D.Util.pointInCircle=function(t,e){var i=e.point,r=e.radius;return D.Util.distance(t,i)<=r},D.Util.pointInPoly=function(t,e){for(var i=!1,r=-1,n=e.length,o=n-1;++r<n;o=r)(e[r].y<=t.y&&t.y<e[o].y||e[o].y<=t.y&&t.y<e[r].y)&&t.x<(e[o].x-e[r].x)*(t.y-e[r].y)/(e[o].y-e[r].y)+e[r].x&&(i=!i);return i},D.Util.preventDefault=function(t){t.preventDefault?t.preventDefault():window.event.returnValue=!1},D.Util.stopPropagation=function(t){t.stopPropagation?t.stopPropagation():window.event.cancelBubble=!0},D.Util.getButton=function(t){if(t=t||window.event,!+[1])switch(t.button){case 0:case 1:case 3:case 5:case 7:return 0;case 2:case 6:return 2;case 4:return 1}return t.button},D.Util.createTextArea=function(t,e,i,r){var n=document.createElement("textarea");return n.id=t,n.style.width=e+"px",n.style.height=i+"px",n.style.resize="none",r&&(n.style.position="absolute"),n.style.zIndex=1,n},D.Util.colorRgb=function(t,e){return"rgba("+parseInt("0x"+t.slice(1,3),10)+","+parseInt("0x"+t.slice(3,5),10)+","+parseInt("0x"+t.slice(5,7),10)+","+e+")"},D.Util.getIEVersion=function(){var t=window.navigator.userAgent.toLowerCase();return/msie 8\.0/i.test(t)?8:/msie 7\.0/i.test(t)?7:/msie 6\.0/i.test(t)?6:0},D.Util.formatGeoPointsWithDlt=function(t,e,i,r){for(var n=e.length,o=t.getZoom()/t.getSize().w,s=i*o,a=r*o,l=[],h=0;h<n;h++){var c=e[h];l.push({x:c.x+s,y:c.y-a})}return l},D.Util.formatGeoPointsWithDeleteIndex=function(t,e,i){for(var r=t.length,n=i||3,o=[],s=0;s<r;s++){var a=t[s];(s!==e||r<=n)&&o.push({x:a.x,y:a.y})}return o},D.Util.calRectNewPointsWithNodesIndexTmpPoint=function(t,e,i,r,n){for(var o=e.length,s=t.getZoom()/t.getSize().w,a=r*s,l=n*s,h=[],c=[],u=0;u<o;u++){var d=e[u],y=D.Util.worldToScreen(t,d.x,d.y);-1!==i.indexOf(u)?(h.push({x:d.x+a,y:d.y-l}),c.push({x:y.x+r,y:y.y+n})):(h.push({x:d.x,y:d.y}),c.push({x:y.x,y:y.y}))}return{points:h,sPoints:c}},D.Util.calPolygonNewPointsWithNodesIndexTmpPoint=function(t,e,i,r){for(var n=e.length,o=[],s=[],a=0;a<n;a++){var l=e[a],h=D.Util.worldToScreen(t,l.x,l.y);if(o.push({x:l.x,y:l.y}),s.push({x:h.x,y:h.y}),a===i){o.push({x:r.x,y:r.y});var c=D.Util.worldToScreen(t,r.x,r.y);s.push({x:c.x,y:c.y})}}return{points:o,sPoints:s}},D.Util.calRectNewPointsWithNodesIndexFormalPoint=function(t,e,i,r,n,o,s){for(var a=e.length,l=t.getZoom()/t.getSize().w,h=n*l,c=o*l,u=[],d=[],y=0;y<a;y++){var f=e[y],p=D.Util.worldToScreen(t,f.x,f.y),g=i.indexOf(y);"y"===s&&0===g||"x"===s&&1===g?(u.push({x:f.x,y:f.y-c}),d.push({x:p.x,y:p.y+o})):"y"===s&&1===g||"x"===s&&0===g?(u.push({x:f.x+h,y:f.y}),d.push({x:p.x+n,y:p.y})):y===r?(u.push({x:f.x+h,y:f.y-c}),d.push({x:p.x+n,y:p.y+o})):(u.push({x:f.x,y:f.y}),d.push({x:p.x,y:p.y}))}return{points:u,sPoints:d}},D.Util.calPolygonNewPointsWithNodesIndexFormalPoint=function(t,e,i,r,n){for(var o=e.length,s=t.getZoom()/t.getSize().w,a=r*s,l=n*s,h=[],c=[],u=0;u<o;u++){var d=e[u],y=D.Util.worldToScreen(t,d.x,d.y);u===i?(h.push({x:d.x+a,y:d.y-l}),c.push({x:y.x+r,y:y.y+n})):(h.push({x:d.x,y:d.y}),c.push({x:y.x,y:y.y}))}return{points:h,sPoints:c}},D.Util.getBounds=function(t,e){if(!t.length)return[];for(var i=t[0].x,r=t[0].y,n=t[0].x,o=t[0].y,s=1;s<t.length;s++)i>t[s].x&&(i=t[s].x),n<t[s].x&&(n=t[s].x),r>t[s].y&&(r=t[s].y),o<t[s].y&&(o=t[s].y);return"bbox"===e?[i,o,n-i,o-r]:[{x:i,y:o},{x:n,y:o},{x:n,y:r},{x:i,y:r}]},D.Util.Key={},D.Util.Key.EVENT="on",D.Util.Key.FLAG={},D.Util.Key.EVENTS={},D.Util.Key.addEventListener=function(t,e){var i=t.join("_");D.Util.Key.EVENTS[i]=e},D.Util.Key.removeEventListener=function(t){var e=t.join("_");delete D.Util.Key.EVENTS[e]},document.addEventListener("keydown",function(t){var e=t.keyCode;if(D.Util.Key.FLAG[e]=!0,"off"!==D.Util.Key.EVENT)for(var i in D.Util.Key.EVENTS){var r=i.split("_"),n=D.Util.Key.EVENTS[i],o=!0;r.forEach(function(t){D.Util.Key.FLAG[1*t]||(o=!1)}),o&&n()}}),document.addEventListener("keyup",function(t){var e=t.keyCode;D.Util.Key.FLAG[e]=!1}),D.Util.Key.isActive=function(t){return D.Util.Key.FLAG[t+""]},D.Util.getCirclePoints=function(t,e,i){for(var r=parseInt(360/i,10),n=[],o=0;o<i;o++){var s=o*r,a=t.x+Math.cos(2*Math.PI/360*s)*e,l=t.y+Math.sin(2*Math.PI/360*s)*e;n.push({x:parseFloat(a.toFixed(2)),y:parseFloat(l.toFixed(2))})}return n},D.Util.combinePolygons=function(t){if(t.length<1)return[];if(1===t.length)return t[0];for(var e=t[0].map(function(t){return[t.x,t.y]}),i=PolyBool.segments({regions:[e],inverted:!1}),r=1,n=t.length;r<n;r++){var o=t[r].map(function(t){return[t.x,t.y]}),s=PolyBool.segments({regions:[o],inverted:!1}),a=PolyBool.combine(i,s);i=PolyBool.selectUnion(a)}return(PolyBool.polygon(i).regions[0]||[]).map(function(t){return{x:t[0],y:t[1]}})},D.Util.colorRGB2Hex=function(t){var e=t.split(",");return"#"+((1<<24)+(parseInt(e[0].split("(")[1],10)<<16)+(parseInt(e[1],10)<<8)+parseInt(e[2].split(")")[0],10)).toString(16).slice(1)},D.Util.colorRGB2Hex2=function(t,e,i){return"#"+((1<<24)+(t<<16)+(e<<8)+i).toString(16).slice(1)},D.Util.distance=function(t,e){var i=t.x,r=t.y,n=e.x,o=e.y,s=Math.abs(n-i),a=Math.abs(o-r);return Math.sqrt(Math.pow(s,2)+Math.pow(a,2))},D.Util.distancePoint2Line=function(t,e,i,r,n,o){var s,a,l=n-i,h=o-r,c=l*l+h*h,u=-1;0!==c&&(u=((t-i)*l+(e-r)*h)/c),a=u<0?(s=i,r):1<u?(s=n,o):(s=i+u*l,r+u*h);var d=t-s,y=e-a;return Math.sqrt(d*d+y*y)},D.Util.pointToSegDistance=function(t,e,i,r,n,o){var s=(n-i)*(t-i)+(o-r)*(e-r);if(s<=0)return Math.sqrt((t-i)*(t-i)+(e-r)*(e-r));var a=(n-i)*(n-i)+(o-r)*(o-r);if(a<=s)return Math.sqrt((t-n)*(t-n)+(e-o)*(e-o));var l=s/a,h=i+(n-i)*l,c=r+(o-r)*l;return Math.sqrt((t-h)*(t-h)+(c-e)*(c-e))},D.Util.distancePoint2Line=function(t,e,i,r,n,o){var s,a,l=n-i,h=o-r,c=l*l+h*h,u=-1;0!==c&&(u=((t-i)*l+(e-r)*h)/c),a=u<0?(s=i,r):1<u?(s=n,o):(s=i+u*l,r+u*h);var d=t-s,y=e-a;return Math.sqrt(d*d+y*y)},D.Util.polygonArea=function(t){var e,i,r=0;for(e=0;e<t.length;e++)i=(e+1)%t.length,r+=t[e].x*t[i].y,r-=t[e].y*t[i].x;return r/=2,Math.abs(r)},D.Util.roiAreasOrderByLevel=function(t){for(var e=[],i=t.concat([]);0<i.length;)L(i).forEach(function(t){i.shift(),e.unshift(t),t.children&&i.push.apply(i,L(t.children))});return e},D.Util.polygonCross=function(t,e){return function(t,e){for(var i=0,r=t.length;i<r;i++)for(var n=0,o=e.length;n<o;n++)if(c([t[i],t[i===r-1?0:i+1]],[e[n],e[n===o-1?0:n+1]]))return!0;return!1}(t,e)||(r=e,o=!1,(n=(i=t).some(function(t){return u(t,r)}))||(o=r.some(function(t){return u(t,i)})),n||o);var i,r,n,o},D.Util.lineLineCross=function(t,e,i,r){var n=(r.x-i.x)*(t.y-i.y)-(r.y-i.y)*(t.x-i.x),o=(e.x-t.x)*(t.y-i.y)-(e.y-t.y)*(t.x-i.x),s=(r.y-i.y)*(e.x-t.x)-(r.x-i.x)*(e.y-t.y);if(0!==s){var a=n/s,l=o/s;if(0<=a&&a<=1&&0<=l&&l<=1)return!0}return!1},D.Util.lineCrossPolygon=function(t,e,i){for(var r=i.length,n=0;n<r;++n){var o=i[n],s=i[(n+1)%r];if(D.Util.lineLineCross(t,e,o,s))return!0}return!1},D.Util.polygonInPolygon=function(t,e){for(var i=!0,r=0;r<t.length;r++)if(!D.Util.pointInPoly(t[r],e)){i=!1;break}for(var n=0;n<t.length;++n){var o=t[n],s=t[(n+1)%t.length];if(D.Util.lineCrossPolygon(o,s,e)){i=!1;break}}return i},D.Util.getParent=function(t,e){return function n(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],o=1<arguments.length?arguments[1]:void 0,s=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[];return t.reduce(function(t,e){var i=e.id,r=e.children;return i===o.id?L(s):r?[].concat(L(t),L(n(r,o,[].concat(L(s),[e])))):t},[])}(t,e)},D.Util.polygonCrossWithParentChildren=function(e,t,i){for(var r=t.children.filter(function(t){return t.id!==e.id}),n=!1,o=0;o<r.length;o++)if(D.Util.polygonCross(r[o].points,i)){n=!0;break}return n},D.Util.childrenInCurrentPolygon=function(t,e){var i=!0;if(e.children&&e.children.length)for(var r=e.children.length,n=0;n<r;n++)if(!D.Util.polygonInPolygon(e.children[n].points,t)){i=!1;break}return i},D.Util.isBBoxIntersect=function(t,e){return!0},D.Graph={},D.Graph.drawPoint=function(t,e,i){var r=D.Util.transformScreenXYWithDpr(e),n=D.Util.getDpr();t.beginPath(),t.arc(r.x,r.y,(i||3)*n,0,2*Math.PI,!0),t.closePath(),t.fill()},D.Graph.drawPoints=function(t,e,i){for(var r=0;r<e.length;r++){var n={x:e[r].x,y:e[r].y};this.drawPoint(t,n,i)}},D.Graph.drawGeoPoint=function(t,e,i,r){var n=D.Util.worldToScreen(t,i.x,i.y),o=D.Util.transformScreenXYWithDpr(n),s=D.Util.getDpr();e.beginPath(),e.arc(o.x,o.y,(r||3)*s,0,2*Math.PI,!0),e.closePath(),e.fill()},D.Graph.drawGeoPoints=function(t,e,i,r){for(var n=0;n<i.length;n++){var o=D.Util.worldToScreen(t,i[n].x,i[n].y);this.drawPoint(e,o,r)}},D.Graph.drawLine=function(t,e,i){t.beginPath();var r=D.Util.transformScreenXYWithDpr(e),n=D.Util.transformScreenXYWithDpr(i);t.moveTo(r.x,r.y),t.lineTo(n.x,n.y),t.stroke()},D.Graph.drawLines=function(t,e){if(!(e.length<2)){t.beginPath();var i=D.Util.transformScreenXYWithDpr(e[0]);t.moveTo(i.x,i.y);for(var r=1;r<e.length;r++){var n=D.Util.transformScreenXYWithDpr(e[r]);t.lineTo(n.x,n.y)}t.stroke()}},D.Graph.drawLines2=function(t,e){if(!(e.length<2)){t.beginPath(),t.moveTo(e[0].x,e[0].y);for(var i=1;i<e.length;i++)t.lineTo(e[i].x,e[i].y);t.stroke()}},D.Graph.drawGeoLine=function(t,e,i,r){e.beginPath();var n=D.Util.worldToScreen(t,i.x,i.y),o=D.Util.worldToScreen(t,r.x,r.y);D.Graph.drawLine(e,n,o)},D.Graph.drawGeoLines=function(t,e,i){if(!(i.length<2)){e.beginPath();var r=D.Util.worldToScreen(t,i[0].x,i[0].y),n=D.Util.transformScreenXYWithDpr(r);e.moveTo(n.x,n.y);for(var o=1;o<i.length;o++){var s=D.Util.worldToScreen(t,i[o].x,i[o].y),a=D.Util.transformScreenXYWithDpr(s);e.lineTo(a.x,a.y)}e.stroke()}},D.Graph.drawRect=function(t,e,i,r){var n=D.Util.getDpr(),o=D.Util.transformScreenXYWithDpr(e);t.strokeRect(o.x,o.y,i*n,r*n)},D.Graph.drawGeoRect=function(t,e,i,r,n){var o=D.Util.getDpr(),s=D.Util.worldToScreen(t,i.x,i.y),a=D.Util.worldToScreenSize(t,r,n),l=D.Util.transformScreenXYWithDpr(s);e.strokeRect(l.x,l.y,a.w*o,a.h*o)},D.Graph.drawPolygon=function(t,e,i){var r=e.length;if(2<=r){t.beginPath();var n=D.Util.transformScreenXYWithDpr(e[0]);t.moveTo(n.x,n.y);for(var o=1;o<r;o++)n=D.Util.transformScreenXYWithDpr(e[o]),t.lineTo(n.x,n.y);t.closePath()}!i&&t.stroke()},D.Graph.drawGeoLineWith=function(t,e,i,r){var n=D.Util.worldToScreen(t,i.x,i.y),o=D.Util.worldToScreen(t,r.x,r.y),s=D.Util.transformScreenXYWithDpr(n),a=D.Util.transformScreenXYWithDpr(o);e.beginPath(),e.moveTo(s.x,s.y),e.lineTo(a.x,a.y),e.closePath(),e.stroke()},D.Graph.drawGeoPolygon=function(t,e,i,r){var n=i.length;if(2<=n){e.beginPath();var o=D.Util.worldToScreen(t,i[0].x,i[0].y),s=D.Util.transformScreenXYWithDpr(o);e.moveTo(s.x,s.y);for(var a=1;a<n;a++){var l=D.Util.worldToScreen(t,i[a].x,i[a].y),h=D.Util.transformScreenXYWithDpr(l);e.lineTo(h.x,h.y)}e.closePath()}e.stroke(),r&&e.fill()},D.Graph.drawDashGeoPolygon=function(t,e,i){var r=i.length;if(2<=r){e.beginPath();var n=D.Util.worldToScreen(t,i[0].x,i[0].y),o=D.Util.transformScreenXYWithDpr(n);e.moveTo(o.x,o.y);for(var s=1;s<r;s++){var a=D.Util.worldToScreen(t,i[s].x,i[s].y),l=D.Util.transformScreenXYWithDpr(a);if(e.lineTo(l.x,l.y),s===r-1){if(e.stroke(),r<=2)return;var h=e.globalAlpha;e.setLineDash([10,20]),e.globalAlpha=.3,e.beginPath(),e.moveTo(l.x,l.y),e.lineTo(o.x,o.y),e.stroke(),e.setLineDash([]),e.globalAlpha=h}}}},D.Graph.drawText=function(t,e,i,r){var n=D.Util.transformScreenXYWithDpr({x:i,y:r});e.fillText(t,n.x,n.y)},D.Graph.drawGeoText=function(t,e,i,r,n){var o=D.Util.worldToScreen(t,r,n),s=D.Util.transformScreenXYWithDpr(o);i.fillText(e,s.x,s.y)},D.Graph.drawGeoRectCross=function(t,e,i){var r=i.map(function(t){return t.x}),n=i.map(function(t){return t.y}),o=Math.min.apply(null,r),s=Math.max.apply(null,r),a=Math.min.apply(null,n),l=Math.max.apply(null,n),h=(o+s)/2,c=(a+l)/2,u=1*(s-o)/3,d=1*(l-a)/3,y={start:{x:o+u,y:c},end:{x:o+2*u,y:c}},f={start:{x:h,y:a+d},end:{x:h,y:a+2*d}},p=y.start,g=y.end,v=f.start,x=f.end;D.Graph.drawGeoLine(t,e,p,g),D.Graph.drawGeoLine(t,e,v,x)},D.Graph.clearGeoArc=function(t,e,i,r,n,o){var s=e.x,a=e.y,l=D.Util.worldToScreen(t,s,a),h=D.Util.transformScreenXYWithDpr(l);r.save(),r.beginPath(),r.arc(h.x,h.y,i,0,2*Math.PI),r.clip(),r.clearRect(0,0,n,o),r.restore()},D.Graph.drawClearGeoPolygon=function(t,e,i){var r=i.length;if(2<=r){e.beginPath();var n=D.Util.worldToScreen(t,i[0].x,i[0].y),o=D.Util.transformScreenXYWithDpr(n);e.moveTo(o.x,o.y);for(var s=1;s<r;s++){var a=D.Util.worldToScreen(t,i[s].x,i[s].y);o=D.Util.transformScreenXYWithDpr(a),e.lineTo(o.x,o.y)}e.closePath()}},D.Graph.clearGeoPolygon=function(t,e,i,r,n){i.save(),i.beginPath(),D.Graph.drawClearGeoPolygon(t,i,e),i.clip(),i.clearRect(0,0,r,n),i.restore()},D.Graph.drawGeoRoi=function(t,e,i){i.beginPath(),D.Graph.drawClearGeoPolygon(t,i,e),i.clip()},D.Geometry=o.extend({init:function(t){this.name=t},getVertices:function(){},getBounds:function(){},calcBounds:function(){}}),D.Geometry.Point=o.extend({init:function(t,e){this.x=t,this.y=e,this.className="point"}}),D.Geometry.LineString=D.Geometry.extend({init:function(t){this.className="line",this.points=[];for(var e=0;e<t.length;e++){var i=t[e];i instanceof D.Geometry.Point?this.points.push(i):alert("初始化节点失败！")}},addPoint:function(t,e){/^\d+$/.test(e)?this.points.splice(e,0,t):this.points.push(t)},delPoint:function(t){this.points.splice(t,1)},removePoint:function(t){for(var e=0;e<this.points.length;e++)if(this.points[e]===t){this.points.splice(e,1);break}},getLength:function(){for(var t=this.points.length,e=0,i=0;i<t-1;i++){e+=Math.sqrt((this.points[i].x-this.points[i+1].x)*(this.points[i].x-this.points[i+1].x)+(this.points[i].y-this.points[i+1].y)*(this.points[i].y-this.points[i+1].y))}return e}}),D.Geometry.LinearRing=D.Geometry.LineString.extend({init:function(t){if(t.length<=2)alert("组成多边形节点个数不足！");else{this._super(t),this.className="polygon";var e=t[0];this.points.push(e)}},addPoint:function(t,e){this.points.splice(e,0,t)},delPoint:function(t){if(4!==this.points.length){if(this.points.splice(t,1),0===t){this.points.pop();var e=this.points[0];this.points.push(e)}}else alert("节点数低于3个，不能删除！")},getCenterPoint:function(){for(var t=this.points,e=t.length,i=0,r=0,n=0;n<e;n++)i+=t[n].x,r+=t[n].y;var o=i/e,s=r/e;return new D.Geometry.Point(o,s)},getArea:function(){for(var t=0,e=this.points,i=0;i<e.length;i++)t+=e[i].x*e[(i+1)%e.length].y-e[(i+1)%e.length].x*e[i].y;return parseInt(Math.abs(.5*t),10)}}),D.Geometry.RectRing=D.Geometry.LineString.extend({init:function(t){t.length<4?alert("组成矩形节点个数不足！"):(this._super(t),this.className="rect")},addPoint:function(t,e){this.points.splice(e,0,t)},delPoint:function(t){if(4!==this.points.length){if(this.points.splice(t,1),0===t){this.points.pop();var e=this.points[0];this.points.push(e)}}else alert("节点数低于3个，不能删除！")},getArea:function(){for(var t=0,e=this.points,i=0;i<e.length;i++)t+=e[i].x*e[(i+1)%e.length].y-e[(i+1)%e.length].x*e[i].y;return parseInt(Math.abs(.5*t),10)}}),D.Geometry.RadiusRing=D.Geometry.extend({init:function(t,e){this.radius=e,this.centerPoint=t,this.className="radius"},getArea:function(){return 6.28318*this.radius*this.radius}}),D.Feature=o.extend({init:function(t,e,i,r,n){this.activeStatus=!1,this.hoverStatus=!1,this.visible=!1,this.id=t,this.points=e instanceof Array?e:[e],this.data=i||{},this.gStyle=r,this.options=n||{}},onAdd:function(t){this._layerID=t.id,this._layer=t,this.visible=!0,this.setEditVertices(),this.setCrossLine(),this.style=this.gStyle||t.featureStyle||new D.Style({}),this.hoveStyle=t.featureHoverStyle||new D.Style({strokeColor:"#FF0000",lineWeight:1}),this.activeStyle=t.featureActiveStyle||new D.Style({strokeColor:"#FF0000",lineWeight:1}),this.onDraw(t)},setCrossLine:function(){},onRemove:function(t){},getVertices:function(){return this.points},setEditVertices:function(){console.log("--this--",this);var t=this.points,e=this.options&&this.options.edgeFixed,i=t.length,r=this._layer.getMap(),n="point"===this.type,o="polyline"===this.type,s=[];if(n)return s;for(var a=0;a<i-1;a++){var l=t[a],h=t[a+1],c=-1<a-1?a-1:o?void 0:i-1,u=void 0===c?void 0:(t[c].y-h.y)/(t[c].x-h.x);s.push({point:l,sPoint:D.Util.worldToScreen(r,l.x,l.y),type:"formal",index:a,k:u?-1/u:void 0,relationNodesIndex:[c,a+1]});var d={x:(l.x+h.x)/2,y:(l.y+h.y)/2},y=(h.y-l.y)/(h.x-l.x);if(!e&&s.push({point:d,sPoint:D.Util.worldToScreen(r,d.x,d.y),type:"tmp",index:a,k:-1/y,relationNodesIndex:[a,a+1]}),a===i-2){var f=o?void 0:0,p=void 0===f?void 0:(t[f].y-l.y)/(t[f].x-l.x);if(s.push({point:h,sPoint:D.Util.worldToScreen(r,h.x,h.y),type:"formal",index:a+1,k:p?-1/p:void 0,relationNodesIndex:[a,f]}),!o){var g=t[f],v={x:(g.x+h.x)/2,y:(g.y+h.y)/2},x=(t[f].y-h.y)/(t[f].x-h.x);!e&&s.push({point:v,sPoint:D.Util.worldToScreen(r,v.x,v.y),type:"tmp",index:a,k:-1/x,relationNodesIndex:[a+1,f]})}}}this._editPoints=s},catchPointWithPos:function(t){if(!this.visible||"point"===this.type)return{flag:!1,point:null};for(var e=this._editPoints,i=this._layer.getMap(),r=D.Util.worldToScreen(i,t.x,t.y),n=e.length,o=0;o<n;o++){var s=e[o].sPoint,a=(r.x-s.x)*(r.x-s.x)+(r.y-s.y)*(r.y-s.y);if(Math.sqrt(a)<=10)return{flag:!0,point:e[o]}}return{flag:!1,point:null}},show:function(){this.visible||(this.visible=!0,this._layer.renew())},hide:function(){this.visible&&(this.visible=!1,this._layer.renew())},update:function(t){"point"===this.type?this.points=t.point?t.point instanceof Array?t.point:[t.point]:this.points:this.points=t.points?t.points instanceof Array?t.points:[t.points]:this.points,this.data=t.data||this.data,this.style=t.style||this.style,t.points&&(this.setEditVertices(),this.setCrossLine()),this._layer.renew()},hover:function(t){this.hoverStatus||(this.hoveStyle=t||this.hoveStyle,this.hoverStatus=!0,this._layer.renew())},deHover:function(){this.hoverStatus&&(this.hoverStatus=!1,this._layer.renew())},active:function(t){this.activeStatus||"point"===this.type||(this.activeStyle=t||this.activeStyle,this.activeStatus=!0,this._layer.renew())},deActive:function(){this.activeStatus&&"point"!==this.type&&(this.activeStatus=!1,this._layer.renew())},getStyle:function(){return this.activeStatus||this.hoverStatus,this.style},getBounds:function(){for(var t=this.getVertices(),e=t[0].x,i=t[0].y,r=t[0].x,n=t[0].y,o=1;o<t.length;o++)e>t[o].x&&(e=t[o].x),r<t[o].x&&(r=t[o].x),i>t[o].y&&(i=t[o].y),n<t[o].y&&(n=t[o].y);return[{x:e,y:n},{x:r,y:n},{x:r,y:i},{x:e,y:i}]},setVerticesActiveStatus:function(){if(this.activeStatus){var t=this._layer.getCtx(),e=this._layer.getMap(),i=this._editPoints.filter(function(t){return"formal"===t.type}),r=this._editPoints.filter(function(t){return"tmp"===t.type});t.globalAlpha=1,t.fillStyle="#FF0000",D.Graph.drawGeoPoints(e,t,i.map(function(t){return t.point})),t.globalAlpha=1,t.fillStyle="#FF9900",D.Graph.drawGeoPoints(e,t,r.map(function(t){return t.point}))}}}),D.Feature.Close=D.Feature.extend({isCaught:function(t){return!(!D.Util.pointInPoly(t,this.points)||!this.visible)},getStyleSize:function(){var t=D.Util.getDpr();return this.style.lineWeight*t},onDraw:function(t){if(this.visible){var e=t.getCtx(),i=this.getStyle(),r=D.Util.getDpr();D.Util.setStyle(e,i),this.hoverStatus&&!this.activeStatus&&(this.cross?e.strokeStyle="#FFD700":e.lineWidth=2*i.lineWeight*r),i.lineDash?e.setLineDash([10,5]):e.setLineDash([]),e.globalAlpha=1,this.activeStatus&&(e.strokeStyle=this.options.activeColor||"#FF0000");var n=this.points.length;if(2<=n){e.beginPath();var o=D.Util.worldToScreen(t._map,this.points[0].x,this.points[0].y),s=D.Util.transformScreenXYWithDpr(o);e.moveTo(s.x,s.y);for(var a=1;a<n;a++)o=D.Util.worldToScreen(t._map,this.points[a].x,this.points[a].y),s=D.Util.transformScreenXYWithDpr(o),e.lineTo(s.x,s.y);e.closePath()}e.stroke(),t._opacity?e.globalAlpha=0:e.globalAlpha=this.style.opacity,e.fill(),this.setVerticesActiveStatus(),this.drawRectCross(t)}},setCrossLine:function(){if(!this.cross)return this.crossHorizontalLine=null,this.crossVerticalLine=null,void(this.crossCenter=null);var t=this.getBounds(),e=t.map(function(t){return t.x}),i=t.map(function(t){return t.y}),r=Math.min.apply(null,e),n=Math.max.apply(null,e),o=Math.min.apply(null,i),s=Math.max.apply(null,i),a=(r+n)/2,l=(o+s)/2,h=1*(n-r)/3,c=1*(s-o)/3;this.crossHorizontalLine={start:{x:r+h,y:l},end:{x:r+2*h,y:l}},this.crossVerticalLine={start:{x:a,y:o+c},end:{x:a,y:o+2*c}},this.crossCenter={x:a,y:l}},drawRectCross:function(t){var e=t.getCtx(),i=D.Util.getDpr(),r=this.getStyle(),n=r.lineWeight,o=r.strokeColor,s=this.crossHorizontalLine,a=this.crossVerticalLine;if(s&&a){e.lineWidth=n*i,e.setLineDash([]),e.globalAlpha=1,this.hoverStatus?e.strokeStyle="#FFD700":e.strokeStyle=o;var l=s.start,h=s.end,c=a.start,u=a.end;D.Graph.drawGeoLine(t._map,e,l,h),D.Graph.drawGeoLine(t._map,e,c,u)}}}),D.Feature.Rect=D.Feature.Close.extend({init:function(t,e,i,r){var n=4<arguments.length&&void 0!==arguments[4]?arguments[4]:{};this._super(t,e,i,r,n),this.cross=!!n.cross,this.type="rect"}}),D.Feature.Polygon=D.Feature.Close.extend({init:function(t,e,i,r,n){this._super(t,e,i,r,n),this.type="polygon"}}),D.Feature.Point=D.Feature.extend({init:function(t,e,i,r,n){this._super(t,e,i,r,n);var o=(n||{}).radius;this.radius=o,this.type="point"},getStyleSize:function(){var t=this._layer.getMap();return this.radius&&0<this.radius?D.Util.worldToScreenDistance(t,this.radius):this.style.pointRadius},isCaught:function(t){var e=this.points[0],i=this._layer.getMap(),r=e.x,n=e.y,o=t.x,s=t.y,a=Math.abs(o-r),l=Math.abs(s-n),h=Math.sqrt(Math.pow(a,2)+Math.pow(l,2));return D.Util.worldToScreenDistance(i,h)-this.getStyleSize()<=4},onDraw:function(t){if(this.visible){var e=this.getStyle(),i=t.getMap(),r=t.getCtx(),n=this.points[0],o=this.getStyleSize();D.Util.setStyle(r,e),D.Graph.drawGeoPoint(i,r,n,o)}}}),D.Feature.Polyline=D.Feature.extend({init:function(t,e,i,r,n){this._super(t,e,i,r,n);var o=n||{},s=o.width,a=o.unSelected,l=void 0!==a&&a;this.unSelected=l,this.lineWidth=s,this.type="polyline"},getStyleSize:function(){var t=D.Util.getDpr(),e=this._layer.getMap();return this.lineWidth&&0<this.lineWidth?D.Util.worldToScreenDistance(e,this.lineWidth)*t:this.style.lineWeight*t},isCaught:function(t){return!(!this.isCaughtInner(t)||!this.visible||this.unSelected)},isCaughtInner:function(t){for(var e=1e7,i=this._layer.getMap(),r=this.points,n=r.length-1,o=t.x,s=t.y,a=0;a<n;a++){var l=r[a],h=r[a+1],c=void 0,u=(h.x-l.x)*(o-l.x)+(h.y-l.y)*(s-l.y),d=(h.x-l.x)*(h.x-l.x)+(h.y-l.y)*(h.y-l.y);if(u<=0)c=Math.sqrt((o-l.x)*(o-l.x)+(s-l.y)*(s-l.y));else if(d<=u)c=Math.sqrt((o-h.x)*(o-h.x)+(s-h.y)*(s-h.y));else{var y=u/d,f=l.x+(h.x-l.x)*y,p=l.y+(h.y-l.y)*y;c=Math.sqrt((o-f)*(o-f)+(p-s)*(p-s))}c<e&&(e=c)}if(this.lineWidth){var g=e-this.lineWidth/2;return g<=0||D.Util.worldToScreenDistance(i,g)<=4}return D.Util.worldToScreenDistance(i,e)<=4},onDraw:function(t){if(this.visible){var e=t.getMap(),i=t.getCtx(),r=this.getStyle(),n=D.Util.getDpr();if(D.Util.setStyle(i,r),this.lineWidth&&0<this.lineWidth){var o=D.Util.worldToScreenDistance(e,this.lineWidth);i.lineWidth=o*n}var s=r.opacity,a=void 0===s?1:s;if((a||0===a)&&(i.globalAlpha=a),this.hoverStatus&&!this.activeStatus){var l=a+.1;i.globalAlpha=l<=1?l:a-.1}this.activeStatus&&(i.strokeStyle=this.options.activeColor||"#FF0000");var h=this.points.length;if(2<=h){i.beginPath();var c=D.Util.worldToScreen(t._map,this.points[0].x,this.points[0].y),u=D.Util.transformScreenXYWithDpr(c);i.moveTo(u.x,u.y);for(var d=1;d<h;d++)c=D.Util.worldToScreen(t._map,this.points[d].x,this.points[d].y),u=D.Util.transformScreenXYWithDpr(c),i.lineTo(u.x,u.y)}i.stroke(),t._opacity?i.globalAlpha=0:i.globalAlpha=this.style.opacity,this.setVerticesActiveStatus()}}}),D.Feature.Roi=o.extend({init:function(t,e,i,r,n,o){this.activeStatus=!1,this.hoverStatus=!1,this.hoveStyle={},this.id=t,this.visible=!0,this.points=i,this.data=r||{},this.gStyle=n,this.options=o||{},this.roiType=e,this.type="roi",this.children=null},isCaught:function(t){return!(!D.Util.pointInPoly(t,this.points)||!this.visible)},hover:function(t){this.hoverStatus||(this.hoveStyle=t||this.hoveStyle,this.hoverStatus=!0,this._layer.renew())},active:function(t){this.activeStatus||(this.activeStyle=t||this.activeStyle,this.activeStatus=!0,this._layer.renew())},onAdd:function(t){this._layer=t,this.setEditVertices(),this.style=this.gStyle||t.featureStyle||new D.Style({}),this.hoveStyle=t.featureHoverStyle||new D.Style({strokeColor:"#FF0000",lineWeight:1}),this.activeStyle=t.featureActiveStyle||new D.Style({strokeColor:"#FF0000",lineWeight:1})},setEditVertices:function(){for(var t=this.points,e=t.length,i=this._layer._map,r=[],n=0;n<e-1;n++){var o=t[n],s=t[n+1],a=-1<n-1?n-1:e-1,l=void 0===a?void 0:(t[a].y-s.y)/(t[a].x-s.x);r.push({point:o,sPoint:D.Util.worldToScreen(i,o.x,o.y),type:"formal",index:n,k:l?-1/l:void 0,relationNodesIndex:[a,n+1]});var h={x:(o.x+s.x)/2,y:(o.y+s.y)/2},c=(s.y-o.y)/(s.x-o.x);if(r.push({point:h,sPoint:D.Util.worldToScreen(i,h.x,h.y),type:"tmp",index:n,k:-1/c,relationNodesIndex:[n,n+1]}),n===e-2){var u=(t[0].y-o.y)/(t[0].x-o.x);r.push({point:s,sPoint:D.Util.worldToScreen(i,s.x,s.y),type:"formal",index:n+1,k:u?-1/u:void 0,relationNodesIndex:[n,0]});var d=t[0],y={x:(d.x+s.x)/2,y:(d.y+s.y)/2},f=(t[0].y-s.y)/(t[0].x-s.x);r.push({point:y,sPoint:D.Util.worldToScreen(i,y.x,y.y),type:"tmp",index:n,k:-1/f,relationNodesIndex:[n+1,0]})}}this._editPoints=r},setVerticesActiveStatus:function(){if(this.activeStatus){var t=this._layer._ctx,e=this._layer._map,i=this._editPoints.filter(function(t){return"formal"===t.type}),r=this._editPoints.filter(function(t){return"tmp"===t.type});t.globalAlpha=1,t.fillStyle="#FF0000",D.Graph.drawGeoPoints(e,t,i.map(function(t){return t.point})),t.globalAlpha=1,t.fillStyle="#FF9900",D.Graph.drawGeoPoints(e,t,r.map(function(t){return t.point}))}},catchPointWithPos:function(t,e){if(this._layer=t,!this.visible||"point"===this.type)return{flag:!1,point:null};for(var i=this._editPoints,r=this._layer._map,n=D.Util.worldToScreen(r,e.x,e.y),o=i.length,s=0;s<o;s++){var a=i[s].sPoint,l=(n.x-a.x)*(n.x-a.x)+(n.y-a.y)*(n.y-a.y);if(Math.sqrt(l)<=10)return{flag:!0,point:i[s]}}return{flag:!1,point:null}},update:function(t){this.points=t.points?t.points instanceof Array?t.points:[t.points]:this.points,this.data=t.data||this.data,this.style=t.style||this.style,t.points&&this.setEditVertices(),this._layer.renew()},getStyleSize:function(){var t=D.Util.getDpr();return this.style.lineWeight*t}}),D.Marker=o.extend({init:function(t,e){this.id=t,this._img=new Image,this._img.src=e.src,this.src=e.src,this._img.style.position="absolute",this._img.style.zIndex=100,this.info=e},onAdd:function(t){var e=(this._layer=t).getMap(),i=this._container=t.getLayerContainer();this.x=this.info.x,this.y=this.info.y;var r=D.Util.worldToScreen(e,this.info.x,this.info.y);this._img.style.left=r.x+this.info.offset.x+"px",this._img.style.top=r.y+this.info.offset.y+"px",this._img.style.cursor="pointer",i.appendChild(this._img)},onRemove:function(){this._container.removeChild(this._img)},update:function(t){t.src&&(this._img.src=t.src),t.x&&(this.info.x=t.x),t.y&&(this.info.y=t.y),t.offset&&(this.info.offset=t.offset),this.renew()},regEvent:function(t,e){if("click"===t){var i=this;D.Util.addEvtHandler(this._img,"mousedown",function(t){D.Util.preventDefault(t),D.Util.stopPropagation(t)}),D.Util.addEvtHandler(this._img,"mouseup",function(t){0===D.Util.getButton(t)&&e.apply(i,arguments),D.Util.preventDefault(t),D.Util.stopPropagation(t)}),D.Util.addEvtHandler(this._img,"click",function(t){D.Util.preventDefault(t),D.Util.stopPropagation(t)})}},renew:function(){var t=this._layer.getMap(),e=D.Util.worldToScreen(t,this.info.x,this.info.y);this._img.style.left=e.x+this.info.offset.x+"px",this._img.style.top=e.y+this.info.offset.y+"px"},showInfo:function(){console.log("Hello ...")}}),D.Text=o.extend({init:function(t,e,i){this.id=t,this.startPoint=e.pos,this.offset=e.offset||{x:0,y:0},this.maxWidth=void 0,this.visible=![!0,!1].includes(e.visible)||e.visible,(e.width||0===e.width)&&(this.boxWidth=e.width),(e.maxWidth||0===e.maxWidth)&&(this.maxWidth=e.maxWidth),this.padding=1,this.text=e.text,this.gStyle=i},onAdd:function(t){this._layerID=t.id,this._layer=t,this.style=this.gStyle||t.textStyle,this.onDraw(t)},update:function(t){t.pos&&(this.startPoint=t.pos),t.offset&&(this.offset=t.offset),t.text&&(this.text=t.text),t.width&&(this.boxWidth=t.width),t.maxWidth&&(this.maxWidth=t.maxWidth),t.style&&(this.style=t.style),this.renew()},show:function(){this.visible=!0,this.renew()},hide:function(){this.visible=!1,this.renew()},onDraw:function(t){var e=this.startPoint,i=this.offset,r=this.style,n=this.text,o=this.maxWidth,s=this.padding,a=r.fontSize,l=r.fontFamily,h=r.fontColor,c=r.bgColor,u=D.Util.getDpr(),d=a*u,y=s*u;if(this.visible&&n){var f=t.getMap(),p=t.getCtx(),g=D.Util.worldToScreen(f,e.x,e.y),v=D.Util.transformScreenXYWithDpr({x:g.x+i.x,y:g.y+i.y}),x=v.x,m=v.y;p.font="".concat(d,"px ").concat(l),p.globalAlpha=1,p.fillStyle=c;var w=p.measureText(n).width+2*y;o&&o*u<w&&(w=o*u+2*y),p.fillRect(x,m,w,d+2*y),p.fillStyle=h,o?p.fillText(n,x+y,m+d-y,o*u):p.fillText(n,x+y,m+d-y)}},setText:function(t){this.text=t,this.refresh()},setPosition:function(t,e){this.startPoint.x=t,this.startPoint.y=e,this.refresh()},setSize:function(t){var e=t.width,i=t.maxWidth;(e||0===e)&&(this.boxWidth=e),(i||0===i)&&(this.maxWidth=i)},onRemove:function(){},renew:function(){this._layer.renew()},refresh:function(){this.renew()}}),D.Text2=o.extend({init:function(t,e,i){this.id=t,this.startPoint=e.pos,this.offset=e.offset||{x:0,y:0},this.boxWidth="auto",this.boxMaxWidth="initial",this.visible=![!0,!1].includes(e.visible)||e.visible,e.width||0===e.width?this.boxWidth=e.width:(e.maxWidth||0===e.maxWidth)&&(this.boxMaxWidth=e.maxWidth),this.wrap=e.wrap||!1,this.text=e.text,this.style=i||new D.Style({})},onAdd:function(t){var e=this.id,i=D.Util.createDiv(e,void 0,void 0,!0);i.style.borderWidth=0,this.wrap||(i.style.overflow="hidden",i.style.textOverflow="ellipsis",i.style.whiteSpace="nowrap"),this._textContainer=i,(this._container=t.getLayerContainer()).appendChild(this._textContainer),this._layer=t,this.onDraw(t)},update:function(t){t.pos&&(this.startPoint=t.pos),t.offset&&(this.offset=t.offset),t.text&&(this.text=t.text),t.width&&(this.boxWidth=t.width),t.maxWidth&&(this.boxMaxWidth=t.maxWidth),t.style&&(this.style=t.style),this.renew()},show:function(){this.visible=!0,this.renew()},hide:function(){this.visible=!1,this.renew()},onDraw:function(t){var e=D.Util.worldToScreen(t._map,this.startPoint.x,this.startPoint.y);e.x=e.x+this.offset.x,e.y=e.y+this.offset.y,this._textContainer.style.fontSize=this.style.fontSize+"px",this._textContainer.style.lineHeight=this.style.fontSize+"px",this._textContainer.style.fontFamily=this.style.fontFamily+",SimSun",this._textContainer.style.color=this.style.fontColor,this._textContainer.style.borderRadius="1px",this._textContainer.style.boxSizing="border-box",this._textContainer.style.padding="1px",this._textContainer.style.width="auto"===this.boxWidth?"auto":"".concat(this.boxWidth,"px"),this._textContainer.style.maxWidth="initial"===this.boxMaxWidth?"initial":"".concat(this.boxMaxWidth,"px"),this._textContainer.style.background=this.style.bgColor,this._textContainer.textContent=this.text,this.text&&this.visible?this._textContainer.style.display="block":this._textContainer.style.display="none",this._textContainer.style.left=e.x+"px",this._textContainer.style.top=e.y+"px",t._layerContainer.appendChild(this._textContainer)},setText:function(t){this.text=t,this.refresh()},setPosition:function(t,e){this.startPoint.x=t,this.startPoint.y=e},setSize:function(t){var e=t.width,i=t.maxWidth;(e||0===e)&&(this.boxWidth=e),(i||0===i)&&(this.boxMaxWidth=i)},onRemove:function(){this._container.removeChild(this._textContainer)},getContainer:function(){return this._textContainer},renew:function(){var t=this._layer;this.onDraw(t)},refresh:function(){this.renew()}}),D.Style=o.extend({init:function(t){this.oStyle="singleStyle",this.fillColor=t.fillColor?t.fillColor:"#00DD00",this.strokeColor=t.strokeColor?t.strokeColor:"#00DD00",this.lineWeight=t.lineWeight?t.lineWeight:1,this.borderStatus=!t.borderStatus||t.borderStatus,this.pointRadius=t.pointRadius?t.pointRadius:3,this.cirRadius=t.cirRadius?t.cirRadius:3,this.fillStatus=!t.fillStatus||t.fillStatus,this.vtxStatus=!!t.vtxStatus&&t.vtxStatus,this.vtxRadius=t.vtxRadius?t.vtxRadius:3,this.tlr=t.tlr?t.tlr:5,this.opacity=t.opacity||0===t.opacity?t.opacity:1,this.mappingValue=t.mappingValue?t.mappingValue:"default",this.fontSize=t.fontSize?t.fontSize:13,this.fontFamily=t.fontFamily?t.fontFamily:"KaiTi",this.fontColor=t.fontColor?t.fontColor:"#333333",this.bgColor=t.bgColor?t.bgColor:"#ffffff",this.lineDash=t.lineDash||!1}}),D.StyleEx=o.extend({init:function(t,e){this.oStyle="multiStyles",this.styles=t,this.mappingField=e}}),D.Edit={},D.Edit.mouseDown=function(t,e){var i=D.Util.getMouseXY(t._container,e),r=D.Util.screenToWorld(t,i.x,i.y),n=t.mode;switch(D.Edit.setDrawStyle(t),D.Edit.setDrawMaskStyle(t),n){case"drawPoint":case"drawRect":case"drawPolygon":case"drawPolyline":case"drawRoi":case"drawMask":var o=D.Util.getButton(e),s=t.activeFeature,a=t.hoverFeature;if(s){var l=s.type,h=s.options,c=h&&h.edgeFixed;if("rect"===l)t.dragging=!0;else if("polygon"===l||"polyline"===l||"roi"===l){var u=t.activePoint;if(!c&&u&&"formal"===u.type&&2===o){var d=s.points,y=D.Util.formatGeoPointsWithDeleteIndex(d,t.activePoint.index,"polyline"===l?2:3);t.userGeometryEditDone&&t.userGeometryEditDone(l,s,y)}else t.dragging=!0}}else if(a&&"point"===a.type&&2===o)t.userGeometryRemove&&t.userGeometryRemove("point",a),t.tipLayer.clear();else{var f=t.resetLayerStatus("active"),p=new D.Geometry.Point(r.x,r.y);if(f)return void t.resetLayerStatus("active");if("drawPoint"===n&&(t.drawGeometryPoints=[],t.drawGeometryPoints.push(p)),"drawRect"===n)t.drawGeometryPoints.push(p);else if("drawPolygon"===n)t.tipLayer.setGeoText("ctrl+z撤销",r.x,r.y),t.drawGeometryPoints.push(p);else if("drawRoi"===n){if(t.tipLayer.setGeoText("ctrl+z撤销",r.x,r.y),t.userFilterRoiArea)t.userFilterRoiArea(p)&&t.drawGeometryPoints.push(p);else t.drawGeometryPoints.push(p)}else"drawPolyline"===n?(t.tipLayer.setGeoText("ctrl+z撤销",r.x,r.y),t.drawGeometryPoints.push(p)):"drawMask"===n&&D.Edit.storeAndDrawMaskLines(t,r,!0)}break;case"clearMask":D.Edit.storeAndClearMaskLines(t,r,i,!0)}},D.Edit.mouseMove=function(t,e){var i=t.overLayer.getCtx(),r=e.srcElement?D.Util.getMouseXY(t._container,e):e,n=D.Util.screenToWorld(t,r.x,r.y),o=t.mode,s=t.startX,a=t.startY,l=r.x-s,h=r.y-a,c=t.drawGeometryPoints,u=c.length;switch(o){case"drawPoint":case"drawRect":case"drawPolygon":case"drawPolyline":case"drawRoi":case"drawMask":t.overLayer.clear(),t.tipLayer.clear();var d=t.activeFeature,y=t.hoverFeature;if(d){var f=t.activePoint,p=d.points,g=d.type,v=d.options,x=v&&v.edgeFixed;if(t.dragging){t.overLayer.setEditStyle(),t.overLayer.topzIndex();var m=d.getStyleSize();if(i.lineWidth=m,f){var w=[],C=t.activePoint,S=C.type,_=C.relationNodesIndex,P=C.index;if("tmp"===S)if("rect"===g){var b=F(t,l,h);w=D.Util.calRectNewPointsWithNodesIndexTmpPoint(t,p,_,b.dltx,b.dlty)}else"polygon"!==g&&"polyline"!==g&&"roi"!==g||(w=D.Util.calPolygonNewPointsWithNodesIndexTmpPoint(t,p,_[0],n));else if("formal"===S)if("rect"===g){var M=z(t);w=D.Util.calRectNewPointsWithNodesIndexFormalPoint(t,p,_,P,l,h,M.flag)}else"polygon"!==g&&"polyline"!==g&&"roi"!==g||(w=D.Util.calPolygonNewPointsWithNodesIndexFormalPoint(t,p,P,l,h));var U="polyline"===g?"drawLines":"drawPolygon";D.Graph[U](i,w.sPoints),t.withRectCross&&"rect"===g&&D.Graph.drawGeoRectCross(t,i,w.points),t.userGeometryEditing&&t.userGeometryEditing(g,d,w.points)}else{var T=D.Util.formatGeoPointsWithDlt(t,p,l,h),k="polyline"===g?"drawGeoLines":"drawGeoPolygon";D.Graph[k](t,i,T),t.withRectCross&&"rect"===g&&D.Graph.drawGeoRectCross(t,i,T),t.userGeometryEditing&&t.userGeometryEditing(g,d,T)}}else f&&"formal"===f.type&&!x&&(3<p.length&&"polygon"===g||3<p.length&&"roi"===g||2<p.length&&"polyline"===g)&&t.tipLayer.setGeoText("右键删除节点",n.x,n.y)}else if(0<u)if(t.overLayer.topzIndex(),"drawRect"===o){var A=[c[0],{x:n.x,y:c[0].y},n,{x:c[0].x,y:n.y}];D.Graph.drawGeoPolygon(t,i,A),t.withRectCross&&D.Graph.drawGeoRectCross(t,i,A)}else if("drawPolygon"===o||"drawRoi"===o){1<u&&t.tipLayer.setGeoText("双击结束绘制",n.x,n.y);var G=[].concat(L(c),[n]);D.Graph.drawDashGeoPolygon(t,i,G)}else if("drawPolyline"===o){1<=u&&t.tipLayer.setGeoText("双击结束绘制",n.x,n.y);var I=[].concat(L(c),[n]);D.Graph.drawGeoLines(t,i,I)}else"drawMask"===o&&D.Edit.storeAndDrawMaskLines(t,n);else if(y){var W="point"===y.type?"右键删除":"双击选择编辑";t.tipLayer.setGeoText(W,n.x,n.y)}break;case"clearMask":0<u&&D.Edit.storeAndClearMaskLines(t,n,r)}return!0},D.Edit.modeTypeMapping={drawRect:"rect",drawPolygon:"polygon",drawPolyline:"polyline",drawRoi:"roi"},D.Edit.mouseUp=function(t,e){var i=D.Util.getMouseXY(t._container,e),r=D.Util.screenToWorld(t,i.x,i.y),n=t.mode,o=t.startX,s=t.startY,a=i.x-o,l=i.y-s;switch(n){case"drawPoint":case"drawRect":case"drawPolygon":case"drawPolyline":case"drawRoi":case"drawMask":var h=t.activeFeature,c=t.activePoint,u=t.dragging;if(h){var d=h.points,y=h.type;if(u){t.overLayer.clear();var f=[];if(c){var p=c.type,g=c.relationNodesIndex,v=c.index,x=[];if("tmp"===p)if("rect"===y){var m=F(t,a,l);x=D.Util.calRectNewPointsWithNodesIndexTmpPoint(t,d,g,m.dltx,m.dlty)}else"polygon"!==y&&"polyline"!==y&&"roi"!==y||(x=D.Util.calPolygonNewPointsWithNodesIndexTmpPoint(t,d,g[0],r));else if("formal"===p)if("rect"===y){var w=z(t);x=D.Util.calRectNewPointsWithNodesIndexFormalPoint(t,d,g,v,a,l,w.flag)}else"polygon"!==y&&"polyline"!==y&&"roi"!==y||(x=D.Util.calPolygonNewPointsWithNodesIndexFormalPoint(t,d,v,a,l));f=x.points}else f=D.Util.formatGeoPointsWithDlt(t,d,a,l);t.userGeometryEditDone&&t.userGeometryEditDone(y,t.activeFeature,f),t.dragging=!1}}else if(0<t.drawGeometryPoints.length&&"drawPoint"===n){var C=D.Edit.getPointSize(t),S=Math.round(D.Util.screenToWorldDistance(t,C));t.drawGeometryPoints=[t.drawGeometryPoints,0===S?1:S]}else if(0<t.drawGeometryPoints.length&&"drawRect"===n){t.overLayer.clear();var _=t.drawGeometryPoints[0],P=new D.Geometry.Point(r.x,r.y),b=D.Util.getRectPointsWithSAndE(_,P);Math.abs(b[0].x-b[2].x)<2||Math.abs(b[0].y-b[2].y)<2?(t.drawGeometryPoints=[],console.log("invalid points data: 绘制矩形 —— 不是有效矩形框...")):t.drawGeometryPoints=b}else 0<t.drawGeometryPoints.length&&"drawMask"===n&&t.overLayer.clear()}D.Edit.setDrawStyle(t)},D.Edit.mouseDblClick=function(t,e){switch(t.mode){case"drawPoint":case"drawRect":t.tipLayer.clear();break;case"drawPolyline":if(t.overLayer.clear(),t.tipLayer.clear(),t.drawGeometryPoints.pop(),2<=t.drawGeometryPoints.length){var i=D.Edit.getMaskSize(t),r=Math.round(D.Util.screenToWorldDistance(t,i));t.drawGeometryPoints=[t.drawGeometryPoints,0===r?1:r]}else t.drawGeometryPoints=[],console.log("invalid points data: 绘制多段线 —— 不是有效多段线...");break;case"drawRoi":case"drawPolygon":t.overLayer.clear(),t.tipLayer.clear(),t.drawGeometryPoints.pop(),3<=t.drawGeometryPoints.length||(t.drawGeometryPoints=[],console.log("invalid points data: 绘制多边形 —— 不是有效多边形..."));break;case"drawMask":t.overLayer.clear(),t.tipLayer.clear()}},D.Edit.setDrawStyle=function(t){var e=t.overLayer.getCtx();t.globalStyle?D.Util.setStyle(e,t.globalStyle):t.overLayer.setInitStyle()},D.Edit.setDrawMaskStyle=function(t){var e=t.mode,i=t.overLayer.getCtx(),r=D.Edit.getMaskSize(t),n=D.Edit.getMaskColor(t);if("drawMask"===e){var o=D.Util.getDpr();i.lineWidth=r*o,i.strokeStyle=n}},D.Edit.getMaskColor=function(t){var e=t.globalStyle,i=t.overLayer;return e&&e.fillColor?e.fillColor:i.getCtxStyle().fillStyle},D.Edit.getMaskSize=function(t){var e=t.globalStyle,i=t.overLayer;return e&&e.lineWeight?e.lineWeight:i.getCtxStyle().lineWidth},D.Edit.getPointSize=function(t){var e=t.globalStyle;return e&&e.pointRadius?e.pointRadius:3},D.Edit.storeAndDrawMaskLines=function(t,e,i){var r=t.overLayer,n=D.Edit.getMaskSize(t),o=r.getCtx(),s=D.Util.screenToWorldDistance(t,n),a=D.Edit.getMaskColor(t);i&&(t.drawGeometryPoints=[]);var l=!1,h=t.drawGeometryPoints.length;if(h){var c=t.drawGeometryPoints[h-1].point,u=c.x,d=c.y,y=e.x,f=e.y;u===y&&d===f&&(l=!0)}if(!l){var p=D.Edit.getMaskJoinRect(t.drawGeometryPoints,e,s);t.drawGeometryPoints.push({point:e,size:s,color:a,rect:p})}var g=t.drawGeometryPoints.map(function(t){return t.point});D.Graph.drawGeoLines(t,o,g)},D.Edit.storeAndClearMaskLines=function(t,e,i,r){var n=D.Edit.getMaskSize(t),o=t.getAllLayers(),s=D.Util.screenToWorldDistance(t,n);r&&(t.drawGeometryPoints=[]);var a=!1,l=t.drawGeometryPoints.length;if(l){var h=t.drawGeometryPoints[l-1].point,c=h.x,u=h.y,d=e.x,y=e.y;c===d&&u===y&&(a=!0)}if(!a){var f=D.Edit.getMaskJoinRect(t.drawGeometryPoints,e,s),p={point:e,size:s,rect:f};t.drawGeometryPoints.push(p);for(var g=0,v=o.length;g<v;g++){var x=o[g];"maskLayer"===x.oClass&&(x.clearMaskWithCircleSegment({point:e,radius:s/2}),f&&x.clearMaskWithPolygonSegment({points:f}))}}},D.Edit.getMaskJoinRect=function(t,e,i){var r=t.length;if(r<1)return null;var n=t[r-1].point,o=e,s=o.x-n.x,a=o.y-n.y,l=Math.sqrt(s*s+a*a);if(!l||!i)return null;var h=s/l*i,c=a/l*i;return[{x:n.x-c/2,y:n.y+h/2},{x:o.x-c/2,y:o.y+h/2},{x:o.x+c/2,y:o.y-h/2},{x:n.x+c/2,y:n.y-h/2}]},D.Edit.formatMaskPoints=function(){for(var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],e=(1<arguments.length&&arguments[1],[]),i=0,r=t.length;i<r;i++){var n=t[i],o=n.point,s=n.size,a=n.color,l=n.rect,h=s/2,c={type:"polygon",points:l,bbox:l?D.Util.getBounds(l,"bbox"):[],color:a},u={type:"circle",point:o,radius:h,bbox:[o.x-h,o.y+h,s,s],color:a};l&&e.push(c),e.push(u)}return e},D.Map=o.extend({init:function(t,e){this._options=e||{},this.destroy(t),this.privateInitContainer(t),this.privateInitProp(),this.privateInitEvent(),this.overLayer=new D.Layer.Overlay("overlay"),this.tipLayer=new D.Layer.Tip("tip"),this.mLayer=new D.Layer.Marker("markerLayer"),this.addLayer(this.overLayer),this.addLayer(this.tipLayer),this.addLayer(this.mLayer),this.attachEvents(),this.attachSlots(),this.registerShortKeyEvent()},attachEvents:function(){var e=this;e.events={on:function(t,r){switch(t){case"boundsChanged":e.userBoundsChanged=function(){r()};break;case"mouseDown":e.userMouseDown=function(t){var e=r(t);return"boolean"!=typeof e||e};break;case"mouseMove":e.userMouseMove=function(t){r(t)};break;case"geometryEditing":e.userGeometryEditing=function(t,e,i){r(t,e,i)};break;case"geometryEditDone":e.userGeometryEditDone=function(t,e,i){r(t,e,i)};break;case"geometryRemove":e.userGeometryRemove=function(t,e){r(t,e)};break;case"geometryDrawDone":e.userGeometryDrawDone=function(t,e,i){r(t,e,i)};break;case"featureHover":e.userFetureHover=function(t,e,i){r(t,e,i)};break;case"featureSelected":e.userFetureSelected=function(t,e,i){r(t,e,i)};break;case"featureWillSelected":e.userFetureWillSelected=function(t,e,i){r(t,e,i)};break;case"featureStatusReset":e.userFeatureStatusReset=function(t){r(t)};break;case"resize":e.userGMapResize=function(){r()}}}}},attachSlots:function(){var e=this;e.slots={on:function(t,i){switch(t){case"coordsTransformBeforeGeometryDrawDone":e.userCoordsTransformBeforeGeometryDrawDone=function(t,e){return i(t,e)||t};break;case"coordsTransformBeforeRender":e.userCoordsTransformBeforeRender=function(t,e){return i(t,e)||t};break;case"filterRoiArea":e.userFilterRoiArea=function(t){return i(t)}}},off:function(t){switch(t){case"coordsTransformBeforeGeometryDrawDone":e.userCoordsTransformBeforeGeometryDrawDone=null;break;case"coordsTransformBeforeRender":e.userCoordsTransformBeforeRender=null}}}},onBoundsChanged:function(){for(var t=this.getAllControls(),e=0;e<t.length;e++)t[e].boundsWatch();this.userBoundsChanged&&this.userBoundsChanged()},registerShortKeyEvent:function(){var t=this;D.Util.Key.addEventListener([17,90],function(){-1<["drawPolygon","drawPolyline","drawRoi"].indexOf(t.mode)&&t.drawGeometryPoints.length&&(t.drawGeometryPoints.pop(),D.Edit.mouseMove(t,{x:t.middleX,y:t.middleY}))})},handleWindowResize:function(){var t=this._containerSize,e=t.clientWidth,i=t.clientHeight,r=this._container,n=r.clientWidth,o=r.clientHeight;e===n&&i===o||this.resize()},privateInitContainer:function(t){if(this._container=document.getElementById(t),this._container){this._container.innerHTML="",this.w=this._options.w||this._container.clientWidth,this.h=this._options.h||this._container.clientHeight,this._container.style.overflow="hidden",this._container.style.userSelect="none",this._container.oncontextmenu=function(){return!1};var e=this._container,i=e.clientWidth,r=e.clientHeight;this._containerSize={clientWidth:i,clientHeight:r},window.addEventListener("resize",this.handleWindowResize.bind(this))}},getContainer:function(){return this._container},getSize:function(){return{w:this.w,h:this.h}},privateInitProp:function(){this.mode="pan",this.panConfig={zoom:!0},this.dragging=!1,this.autoPanTimer=null,this.autoPanFlag=!(0<=[!0,!1].indexOf(this._options.autoPan))||this._options.autoPan,this.drawZoomFlag=!(0<=[!0,!1].indexOf(this._options.drawZoom))||this._options.drawZoom,this.autoFeatureSelect=!(0<=[!0,!1].indexOf(this._options.autoFeatureSelect))||this._options.autoFeatureSelect,this.oLayers=[],this.oControls=[],this.zoom=this._options.zoom||parseInt(1*this.w,10),this.cx=this._options.cx||0,this.cy=this._options.cy||0,this.startX=0,this.startY=0,this.startScrX=0,this.startSrcY=0,this.middleX=0,this.middleY=0,this.zoomScale=.025,this.zoomMax=this._options.zoomMax||1e9,this.zoomMin=this._options.zoomMin||0,this.drawGeometryPoints=[],this.activeFeature=null,this.activePoint=null,this.withRectCross=!1,this.maskBounds=null,this.drawPointTimer=null},mapMouseDownForPan:function(t){this.dragging=!0;for(var e=this.getAllLayers(),i=0;i<e.length;i++)e[i].startLeft=D.Util.delpx(e[i]._layerContainer.style.left),e[i].startTop=D.Util.delpx(e[i]._layerContainer.style.top)},mapMouseMoveForPan:function(t){var e=D.Util.getMousePos(t);if(this.dragging){var i=e.x-this.startScrX,r=e.y-this.startScrY,n=this.getAllLayers();if(0<Math.abs(i)||0<Math.abs(r))for(var o=0;o<n.length;o++)n[o].onDrag(i,r)}},mapMouseUpForPan:function(t){var e=D.Util.getMousePos(t),i=e.x-this.startScrX,r=e.y-this.startScrY;if(0<Math.abs(i)||0<Math.abs(r)){var n=this.getScreenCenter(),o=n.x-i,s=n.y-r,a=D.Util.screenToWorld(this,o,s);this.setCenter(a.x,a.y)}this.dragging=!1},mapMouseMoveForEdit:function(t){var e=this,i=D.Util.getMouseXY(this._container,t);this.middleX=i.x,this.middleY=i.y,-1<["drawPolygon","drawRect","drawPolyline","drawRoi"].indexOf(this.mode)&&0<this.drawGeometryPoints.length&&(i.x<=10||i.y<=10||i.x>=this.w-10||i.y>=this.h-10)&&!this.autoPanTimer&&this.autoPanFlag?this.autoPanTimer=window.setInterval(function(){return e.mapAutoPanForEdit({left:i.x<=10,right:i.x>=e.w-10,top:i.y<=10,bottom:i.y>=e.h-10})},0):this.autoPanTimer&&(window.clearInterval(this.autoPanTimer),this.autoPanTimer=null),D.Edit.mouseMove(this,t)},mapAutoPanForEdit:function(t){var e=t.left,i=t.right,r=t.top,n=t.bottom,o=this.getScreenCenter(),s=e?-.2:i?.2:0,a=r?-.2:n?.2:0,l=o.x+s,h=o.y+a,c=D.Util.screenToWorld(this,l,h);this.setCenter(c.x,c.y)},coordsTransformBatch:function(e,t,i){var r=this;return this[e]?t.map(function(t){return r[e](t,i)}):t},mapMouseUpForEdit:function(t){var r=this;D.Edit.mouseUp(this,t);var e=this.drawGeometryPoints.length;if(this.overLayer.resetzIndex(),e)switch(this.mode){case"drawPoint":this.clearDrawPointTimer(),this.drawPointTimer=setTimeout(function(){var t=s(r.drawGeometryPoints,2),e=t[0],i=t[1];r.userGeometryDrawDone&&e.length&&r.userGeometryDrawDone("point",e[0],{radius:i}),r.drawGeometryPoints=[],r.clearDrawPointTimer()},200);break;case"drawRect":this.userGeometryDrawDone&&this.userGeometryDrawDone("rect",this.drawGeometryPoints),this.drawGeometryPoints=[];break;case"drawPolygon":case"drawRoi":case"drawPolyline":break;case"drawMask":var i=D.Edit.formatMaskPoints(this.drawGeometryPoints,"draw");this.userGeometryDrawDone&&i&&i.length&&this.userGeometryDrawDone("mask",{key:"".concat((new Date).getTime()),type:"drawMask",segments:i}),this.drawGeometryPoints=[];break;case"clearMask":var n=D.Edit.formatMaskPoints(this.drawGeometryPoints,"clear");this.userGeometryDrawDone&&n&&n.length&&this.userGeometryDrawDone("mask",{key:"".concat((new Date).getTime()),type:"clearMask",segments:n}),this.drawGeometryPoints=[]}},clearDrawPointTimer:function(){this.drawPointTimer&&(clearTimeout(this.drawPointTimer),this.drawPointTimer=null)},privateInitEvent:function(){var x=this,t=this._container;function e(t){var e=t||window.event;window.event||e.preventDefault();var i=D.Util.getMouseXY(x._container,e),r=D.Util.screenToWorld(x,i.x,i.y),n=D.Util.getMousePos(e);x.startX=i.x,x.startY=i.y,x.startScrX=n.x,x.startScrY=n.y,"pan"===x.mode?(x.resetLayerStatus("active"),x.mapMouseDownForPan(e),document.onmousemove=function(t){x.mapMouseMoveForPan(t)},document.onmouseup=function(t){document.onmousemove=null,document.onmouseup=null,x.mapMouseUpForPan(t)}):D.Edit.mouseDown(x,e),x.userMouseDown&&x.userMouseDown(r)}function i(t){x.mapMouseMoveForEdit(t);var e=D.Util.getMouseXY(x._container,t),i=D.Util.screenToWorld(x,e.x,e.y);!x.dragging&&x.handleDrawEditGeometryMouseMove(i),x.userMouseMove&&x.userMouseMove(i),!x.dragging&&x.setTargets(t,i,"hover")}function r(t){x.mapMouseUpForEdit(t)}function n(t){x.clearDrawPointTimer(),"drawPoint"===x.mode&&(x.drawGeometryPoints=[]);var e=D.Util.getMouseXY(x._container,t),i=D.Util.screenToWorld(x,e.x,e.y);if(D.Edit.mouseDblClick(x,t),x.drawGeometryPoints.length)switch(x.mode){case"drawPoint":case"drawRect":break;case"drawPolygon":case"drawRoi":x.userGeometryDrawDone&&x.userGeometryDrawDone("drawPolygon"===x.mode?"polygon":"roi",x.drawGeometryPoints),x.drawGeometryPoints=[];break;case"drawPolyline":var r=s(x.drawGeometryPoints,2),n=r[0],o=r[1];x.userGeometryDrawDone&&x.userGeometryDrawDone("polyline",n,{width:o}),x.drawGeometryPoints=[]}else switch(x.mode){case"drawPoint":case"drawRect":case"drawPolygon":case"drawRoi":case"drawPolyline":case"drawMask":!x.activeFeature&&x.setTargets(t,i,"selected")}}function o(t){D.Util.preventDefault(t);var e=x.drawZoomFlag,i=x.mode,r=x.panConfig,n=D.Util.getMouseXY(x._container,t),o=D.Util.screenToWorld(x,n.x,n.y),s=-1<["drawPolygon","drawRoi","drawPoint","drawPolyline","drawRect","drawMask","clearMask"].indexOf(i),a=e&&s&&r.zoom;if("pan"===x.mode&&r.zoom||a){if(0<(t.wheelDelta||-t.detail)){var l=x.getNewZoom("zoomIn",1);if(x.zoom<=x.zoomMin||l<=x.zoomMin)return;var h=(o.x-x.cx)*(1-x.zoomScale),c=(o.y-x.cy)*(1-x.zoomScale),u=o.x-h,d=o.y-c;x.setCenter(u,d,!0),x.zoomIn(1,"mouseWheel")}else{var y=x.getNewZoom("zoomOut",1);if(x.zoom>=x.zoomMax||y>=x.zoomMax)return;var f=(o.x-x.cx)/(1-x.zoomScale),p=(o.y-x.cy)/(1-x.zoomScale),g=o.x-f,v=o.y-p;x.setCenter(g,v,!0),x.zoomOut(1,"mouseWheel")}s&&x.drawGeometryPoints.length&&D.Edit.mouseMove(x,{x:n.x,y:n.y})}}D.Util.addEvtHandler(t,"mousedown",e),D.Util.addEvtHandler(t,"mousemove",i),D.Util.addEvtHandler(t,"mouseup",r),D.Util.addEvtHandler(t,"mousewheel",o),D.Util.addEvtHandler(t,"dblclick",n),this._mapMouseDown=e,this._mapMouseMove=i,this._mapMouseUp=r,this._mapMouseDblClick=n,this._mapMouseWheel=o},handleDrawEditGeometryMouseMove:function(o){var s=this;switch(s.mode){case"pan":s.setCursor("pointer");break;case"clearMask":s.setCursor("cell");break;case"drawPoint":case"drawRect":case"drawPolyline":case"drawMask":case"drawRoi":case"drawPolygon":if(function(){for(var t=s.getAllLayers(),e=0;e<t.length;e++)if("featureLayer"===t[e].oClass||"roiLayer"===t[e].oClass){var i=t[e].catchFeaturePointWithPos(o,"active");if(i.length)return s.activeFeature=i[0].feature,s.activePoint=i[0].point,!(s.hoverFeature=null);var r=t[e].getFeaturesWithPos(o,"active");if(r.length)return s.activeFeature=r[0],s.activePoint=null,!(s.hoverFeature=null);var n=t[e].getFeaturesWithPos(o,"hover");if(n.length)return s.activeFeature=null,s.activePoint=null,s.hoverFeature=n[0],!1}return s.activeFeature=null,s.activePoint=null,s.hoverFeature=null,!1}()){var t=s.activeFeature;if(s.activePoint&&"rect"===t.type){var e=s.activePoint.k;0<e&&e!==1/0?s.setCursor("nesw-resize"):0===e?s.setCursor("ew-resize"):e<0&&e!==-1/0?s.setCursor("nwse-resize"):s.setCursor("ns-resize")}else s.activePoint&&"polygon"===t.type?s.setCursor("no-drop"):s.activePoint&&"roi"===t.type?s.setCursor("no-drop"):s.activePoint&&"polyline"===t.type?s.setCursor("no-drop"):s.setCursor("move")}else s.setCursor("crosshair")}},setTargets:function(t,e,i){for(var r=this.getAllLayers(),n=[],o=0;o<r.length;o++)n=n.concat(r[o].getFeaturesWithPos(e));var s=this.getTargetFeature(n);if("selected"===i){if(!n.length)return void this.resetLayerStatus("active");if("point"===s.type)return;this.autoFeatureSelect&&s.active(),this.handleDrawEditGeometryMouseMove(e),this.autoFeatureSelect&&this.userFetureSelected&&this.userFetureSelected(s,t,e),!this.autoFeatureSelect&&this.userFetureWillSelected&&this.userFetureWillSelected(s,t,e)}else"hover"===i&&(this.resetLayerStatus("hover"),n.length&&s.hover(),this.userFetureHover&&this.userFetureHover(s,t,e));return this},resetLayerStatus:function(t){for(var e=this.getAllLayers(),i=!1,r=0;r<e.length;r++)"featureLayer"!==e[r].oClass&&"roiLayer"!==e[r].oClass||e[r].resetFeatureStatus(t)&&(i=!0);return t&&"active"===t&&i&&this.userFeatureStatusReset&&this.userFeatureStatusReset(),i},addLayer:function(t){var e=this.oLayers;D.Util.isObjInArray(e,t)||(t.onAdd(this),e.push(t))},removeLayer:function(t){for(var e=[],i=this.oLayers,r=0,n=0;r<i.length;r++)i[r]!==t?(e[n]=i[r],n++):t.onRemove(this);this.oLayers=e},getAllLayers:function(){return this.oLayers},getLayerById:function(t){for(var e=0,i=this.oLayers.length;e<i;e++){var r=this.oLayers[e];if(r.id===t)return r}return null},addControl:function(t){var e=this.oControls;D.Util.isObjInArray(e,t)||(t.onAdd(this),e.push(t))},removeControl:function(t){for(var e=[],i=this.oControls,r=0,n=0;r<i.length;r++)i[r]!==t?(e[n]=i[r],n++):t.onRemove(this);this.oControls=e},getAllControls:function(){return this.oControls},getNewZoom:function(t,e){for(var i=e||6,r=this.zoom;0<i;)"zoomIn"===t?r-=r*this.zoomScale:r/=1-this.zoomScale,i--;return r},getZoom:function(){return this.zoom},setZoom:function(t,e){this.zoom=t,!e&&this.refresh()},zoomIn:function(t,e){var i=this.getNewZoom("zoomIn",t);if(!(this.zoom<=this.zoomMin||i<=this.zoomMin)){var r=this.getAllLayers();this.zoom=i;for(var n=0;n<r.length;n++)r[n].zoomIn(e);this.onBoundsChanged()}},zoomOut:function(t,e){var i=this.getNewZoom("zoomOut",t);if(!(this.zoom>=this.zoomMax||i>=this.zoomMax)){var r=this.getAllLayers();this.zoom=i;for(var n=0;n<r.length;n++)r[n].zoomOut(e);this.onBoundsChanged()}},setMode:function(t,e){var i=e instanceof D.Style;switch(this.mode=t,this.drawGeometryPoints=[],t){case"pan":this.resetLayerStatus(),!i&&e&&(this.panConfig=Object.assign({},this.panConfig,e))}i&&(this.globalStyle=e)},setGlobalStyle:function(t){t&&(this.globalStyle=t)},setPanConfig:function(t){this.panConfig=Object.assign({},this.panConfig,t||{})},setMaskBounds:function(t,e,i,r){this.maskBounds=[t,e,i,r]},setCursor:function(t){var e=this._container.style.cursor;e!==t&&(this.previousCursor=e,this._container.style.cursor=t)},resetCursor:function(){this.setCursor(this.previousCursor)},setRectCross:function(t){this.withRectCross=!!t},getMode:function(){return this.mode},setCenter:function(t,e,i){this.cx=t,this.cy=e,!i&&this.refresh()},centerAndZoom:function(t,e){this.setCenter(t.x,t.y,!0),this.setZoom(e,!0);for(var i=this.getAllLayers(),r=0;r<i.length;r++)i[r].zoomIn();this.onBoundsChanged()},getCenter:function(){return{x:this.cx,y:this.cy}},getScreenCenter:function(){return{x:this.w/2,y:this.h/2}},resize:function(t,e){var i=this.zoom/this.w,r=t||this._container.clientWidth,n=e||this._container.clientHeight;this.zoom=i*r,this.w=r,this.h=n;for(var o=this.getAllLayers(),s=0;s<o.length;s++)o[s].resize();for(var a=this.getAllControls(),l=0;l<a.length;l++)a[l].resize();this.userGMapResize&&this.userGMapResize(this),this.onBoundsChanged()},refresh:function(){for(var t=this.getAllLayers(),e=0,i=t.length;e<i;e++)t[e].renew();this.onBoundsChanged()},destroy:function(t){var e=t?document.getElementById(t):this._container;e.innerHTML="",D.Util.removeEvtHandler(e,"mousedown"),D.Util.removeEvtHandler(e,"mousemove"),D.Util.removeEvtHandler(e,"mouseup"),D.Util.removeEvtHandler(e,"mousewheel"),D.Util.removeEvtHandler(e,"dblclick"),window.removeEventListener("resize",this.handleWindowResize.bind(this))},getTargetFeature:function(t){if(!t.length)return null;var e=[],i=[],r=[],n=[];return t.forEach(function(t){"point"===t.type&&e.push(t),"polyline"===t.type&&i.push(t),("rect"===t.type||"polygon"===t.type)&&r.push(t),("roi"===t.roiType||"notRoi"===t.roiType)&&n.push(t)}),e.length?e[0]:i.length?i[0]:r.length?r.sort(function(t,e){return D.Util.polygonArea(t.points)-D.Util.polygonArea(e.points)})[0]:n.length?n[0]:void 0}}),D.Layer=o.extend({init:function(t,e){this.id=t,this.visible=!0,this.options=e||{opacity:1,zIndex:0}},onAdd:function(t){this._map=t,this._container=t.getContainer();var e=t.getSize();this.privateInitLayerContainer(this.id,e.w,e.h),this.privateInitProp(t),this.privateInitParams(t),this._container.appendChild(this._layerContainer),this.setzIndex(),this.setOpacity(this.options.opacity)},onRemove:function(t){t.getContainer().removeChild(this._layerContainer)},privateInitProp:function(t){},privateInitParams:function(t){},onDrag:function(t,e){this._layerContainer.style.left=this.startLeft+t+"px",this._layerContainer.style.top=this.startTop+e+"px"},zoomIn:function(t){this.renew(t)},zoomOut:function(t){this.renew(t)},zoomTo:function(){this.renew()},renew:function(){this._layerContainer.style.left="0px",this._layerContainer.style.top="0px"},getSize:function(){return{w:this._layerContainer.clientWidth,h:this._layerContainer.clientHeight}},getScreenCenter:function(){return{x:parseInt(this._layerContainer.clientWidth/2,10),y:parseInt(this._layerContainer.clientHeight/2,10)}},getMap:function(){return this._map},getLayerContainer:function(){return this._layerContainer},setzIndex:function(){isNaN(this.options.zIndex)||(this._layerContainer.style.zIndex=this.options.zIndex)},setOpacity:function(t){this.getLayerContainer().style.opacity=t},resize:function(){this._layerContainer.style.width=this._map.w+"px",this._layerContainer.style.height=this._map.h+"px"},getFeaturesWithPos:function(t){return[]},deSelect:function(){}}),D.Layer.Image=D.Layer.extend({init:function(t,e,i,r){this._super(t,r),this._src=e,this._size=i,this.oClass="imgLayer",this.setGridInfo(r.grid)},setGridInfo:function(t){this._gridVisible=!0,this._lineClassName="layer-img-line",this._gridConfig=!!t&&Object.assign({},{rowCount:3,columnCount:3,color:"#000"},this._gridConfig||{},t),this._rowLineProps={position:"absolute",boxSizing:"border-box",height:"1px",width:"100%",left:0,borderTop:"1px solid "+this._gridConfig.color},this._columnLineProps={position:"absolute",boxSizing:"border-box",height:"100%",width:"1px",top:0,borderLeft:"1px solid "+this._gridConfig.color}},privateInitParams:function(t){},privateInitProp:function(t){var e=this;this._super(),this._mapImg||(this._mapImg=new Image),this._mapImg.style.position="absolute",this._mapImg.style.left=0,this._mapImg.style.top=0,this._mapImg.src=this._src,this._mapImg.style.width="100%",this._mapImg.style.height="100%",this._mapImg.onmousedown=function(t){t.preventDefault()},this._mapImg.onload=function(){e.setInnerContainerSize()},this._innerContainerId=this.id+"-inner-container",this._innerContainer=document.createElement("div"),this._innerContainer.id=this._innerContainerId,this._innerContainer.appendChild(this._mapImg),this._innerContainer.style.position="absolute",this._layerContainer.appendChild(this._innerContainer),this.renew()},privateInitLayerContainer:function(t,e,i){var r=D.Util.createDiv(t,e,i,!0);r.style.zIndex=2,this._layerContainer=r},onAdd:function(t){this._super(t),this.setGrid()},zoomTo:function(){},setGrid:function(){var t=this._gridConfig||{},e=t.columnCount,i=void 0===e?0:e,r=t.rowCount,n=void 0===r?0:r;if(this.removeGrid(),this._gridConfig&&this._gridVisible){for(var o=parseInt(100/n*100,10)/100,s=parseInt(100/i*100,10)/100,a=0;a<n-1;a++){var l=document.createElement("div");for(var h in l.className=this._lineClassName,this._rowLineProps)l.style[h]=this._rowLineProps[h];l.style.top=(a+1)*o+"%",this._innerContainer.appendChild(l)}for(var c=0;c<i-1;c++){var u=document.createElement("div");for(var d in u.className=this._lineClassName,this._columnLineProps)u.style[d]=this._columnLineProps[d];u.style.left=(c+1)*s+"%",this._innerContainer.appendChild(u)}}},operateGrid:function(t){var e=document.getElementById(this._innerContainerId);if(e)for(var i=e.getElementsByClassName(this._lineClassName),r=i.length-1;0<=r;r--)"remove"===t&&i[r].remove(),"show"===t&&(i[r].style.display="block"),"hide"===t&&(i[r].style.display="none")},removeGrid:function(){this.operateGrid("remove")},showGrid:function(){this.operateGrid("show")},hideGrid:function(){this.operateGrid("hide")},update:function(t){t&&t.grid&&(this.setGridInfo(t.grid),this.setGrid())},renew:function(){this._super(),this.setInnerContainerSize();var t=D.Util.worldToScreen(this._map,-1*this._size.w/2,this._size.h/2);this._innerContainer.style.left=t.x+"px",this._innerContainer.style.top=t.y+"px"},setInnerContainerSize:function(){var t=this._map.getSize(),e=this._map.zoom/t.w;this._innerContainer.style.width=this._size.w/e+"px",this._innerContainer.style.height=this._size.h/e+"px"},resize:function(){this._super(),this.renew()},refresh:function(){}}),D.Layer.Feature=D.Layer.extend({init:function(t,e){e=e||{},this._super(t,e),this.featureStyle=e.style||new D.Style({}),this.featureHoverStyle=e.hoverStyle||new D.Style({strokeColor:"#FF0000",lineWeight:1}),this.featureActiveStyle=e.activeStyle||new D.Style({strokeColor:"#FF0000",lineWeight:1}),this._opacity=!!e.transparent&&e.transparent,this.editable=!0,this.oClass="featureLayer"},privateInitLayerContainer:function(t,e,i){var r=D.Util.createCanvas(t,e,i,!0);this._layerContainer=r,this._ctx=r.getContext("2d"),this._layerContainer.style.left="0",this._layerContainer.style.top="0"},privateInitProp:function(t){this._super()},setEditable:function(t){this.editable=!!t},onAdd:function(t){var e=(this._map=t).getSize(),i=this._map.getContainer();this.privateInitLayerContainer(this.id,e.w,e.h),i.appendChild(this._layerContainer),this.setzIndex(),this.oFeatures=[]},addFeature:function(t){var e=this.getAllFeatures();D.Util.isInArray(e,t)||(e.push(t),t.onAdd(this))},getFeatureById:function(t){for(var e=this.getAllFeatures(),i=e.length-1;0<=i;i--)if(e[i].id===t)return e[i];return null},getFeaturesWithPos:function(t,e){if(!this.editable)return[];for(var i=[],r=this.getAllFeatures(),n=r.length-1;0<=n;n--){var o=r[n],s=!0;e&&"active"===e&&(s=o.activeStatus),e&&"hover"===e&&(s=!0),o.isCaught(t)&&s&&i.push(o)}return i},catchFeaturePointWithPos:function(t,e){for(var i=[],r=this.getAllFeatures(),n=r.length-1;0<=n;n--){var o=r[n],s=!0;e&&"active"===e&&(s=o.activeStatus);var a=o.catchPointWithPos(t);a.flag&&s&&i.push({feature:o,point:a.point})}return i},resetFeatureStatus:function(t){for(var e=this.getAllFeatures(),i=!1,r=e.length-1;0<=r;r--){var n=e[r];t&&"active"===t?n.activeStatus&&(i=!(n.activeStatus=!1)):t&&"hover"===t?n.hoverStatus&&(i=!(n.hoverStatus=!1)):(n.activeStatus||n.hoverStatus)&&(n.activeStatus=!1,i=!(n.hoverStatus=!1))}return i&&this.renew(),i},getActiveFeatures:function(){for(var t=[],e=this.getAllFeatures(),i=e.length-1;0<=i;i--)e[i].activeStatus&&t.push(e[i]);return t},getHoverFeatures:function(){for(var t=[],e=this.getAllFeatures(),i=e.length-1;0<=i;i--)e[i].hoverStatus&&t.push(e[i]);return t},removeAllFeatures:function(){this.oFeatures=[],this.renew()},removeFeature:function(t){for(var e=[],i=0,r=0;i<this.oFeatures.length;i++)this.oFeatures[i]!==t?(e[r]=this.oFeatures[i],r++):t.onRemove(this);this.oFeatures=e,this.renew()},removeFeatureById:function(t){for(var e=[],i=0,r=this.oFeatures.length;i<r;i++){var n=this.oFeatures[i];n.id!==t?e.push(n):n.onRemove(this)}this.oFeatures=e,this.renew()},removeFeaturesByIds:function(t){for(var e=[],i=[],r=0,n=this.oFeatures.length;r<n;r++){var o=this.oFeatures[r];-1===t.indexOf(o.id)?e.push(o):(o.onRemove(this),i.push(o))}return this.oFeatures=e,this.renew(),i},removeFeaturesByProperty:function(t){for(var e=[],i=[],r=0,n=this.oFeatures.length;r<n;r++){for(var o=this.oFeatures[r],s=!1,a=0,l=t.length;a<l;a++){var h=t[a];if(o.data[h.key]===h.value){s=!0,o.onRemove(this),i.push(o);break}}s||e.push(o)}return this.oFeatures=e,this.renew(),i},draw:function(){this.clear();for(var t=this.getAllFeatures(),e=0;e<t.length;e++)t[e].onDraw(this)},renew2:function(){this._super(),this.clear(),this.draw()},renew:function(t){this._super(),this.clear(),"mouseWheel"===t?this.drawTimer():this.draw()},drawTimer:function(){this._drawTimer&&(clearTimeout(this._drawTimer),this._drawTimer=null);var t=this;this._drawTimer=setTimeout(function(){t.draw()},333)},resize:function(){this._super();var t=D.Util.getDpr();this._layerContainer.width=this._map.w*t,this._layerContainer.height=this._map.h*t,this.renew()},clear:function(){var t=this.getLayerContainer();this._ctx.clearRect(0,0,t.width,t.height)},getAllFeatures:function(){return this.oFeatures},getCtx:function(){return this._ctx}}),D.Layer.Overlay=D.Layer.Feature.extend({init:function(t,e){this._super(t,e),this.options=e||{opacity:1,zIndex:10},this.zIndexTopFlag=!1,this.oClass="overlayLayer"},setStyle:function(t){this.style=t},initStyle:function(){this.setInitStyle(),this._layerContainer.style.left="0",this._layerContainer.style.top="0"},setInitStyle:function(){var t=this.getCtx(),e=D.Util.getDpr();t.strokeStyle="#0000FF",t.fillStyle="#0000FF",t.lineWidth=1*e,t.globalAlpha=.7},getCtxStyle:function(){var t=this.getCtx();return{strokeStyle:t.strokeStyle,fillStyle:t.fillStyle}},setEditStyle:function(){var t=this.getCtx(),e=D.Util.getDpr();t.strokeStyle="#FF0000",t.lineWidth=1*e,t.globalAlpha=.7},onAdd:function(t){this._super(t),this.initStyle()},resize:function(){this._super();var t=D.Util.getDpr();this._layerContainer.width=this._map.w*t,this._layerContainer.height=this._map.h*t,this.renew()},topzIndex:function(){this.zIndexTopFlag||(this._layerContainer.style.zIndex=9999,this.zIndexTopFlag=!0)},resetzIndex:function(){this.zIndexTopFlag&&(this._layerContainer.style.zIndex=this.options.zIndex,this.zIndexTopFlag=!1)}}),D.Layer.Tip=D.Layer.Feature.extend({init:function(t,e){this._super(t,e),this.options=e||{opacity:1,zIndex:11},this.tipsVisible=!0,this.oClass="tipLayer"},setStyle:function(t){this.style=t},initStyle:function(){this.setInitStyle(),this._layerContainer.style.left="0",this._layerContainer.style.top="0"},setInitStyle:function(){var t=this.getCtx(),e=12*D.Util.getDpr();t.font="".concat(e,"px Arial"),t.textAlign="left",t.textBaseline="bottom",t.fillStyle="#fff",t.globalAlpha=1},onAdd:function(t){this._super(t),this.initStyle()},resize:function(){this._super();var t=D.Util.getDpr();this._layerContainer.width=this._map.w*t,this._layerContainer.height=this._map.h*t,this.renew()},showTips:function(){this.tipsVisible=!0},hideTips:function(){this.tipsVisible=!1,this.clear()},setTextBackground:function(t,e,i,r){var n=this.getCtx();n.beginPath(),n.rect(t,e,i,r),n.fillStyle="#333",n.fill(),n.lineWidth=1,n.strokeStyle="#efefef",n.stroke()},setText:function(t,e,i){if(this.clear(),t&&this.tipsVisible){var r=this.getCtx(),n=r.measureText(t).width,o=D.Util.transformScreenXYWithDpr({x:e||0,y:i||0}),s=D.Util.getDpr();this.setTextBackground(o.x+4*s,o.y-16*s,n+7*s,20*s),this.setInitStyle(),r.fillText(t,o.x+7*s,o.y+1*s)}},setGeoText:function(t,e,i){if(this.clear(),t&&this.tipsVisible){var r=this.getCtx(),n=r.measureText(t).width,o=D.Util.worldToScreen(this._map,e||0,i||0),s=D.Util.transformScreenXYWithDpr(o),a=D.Util.getDpr();this.setTextBackground(s.x+4*a,s.y-16*a,n+7*a,20*a),this.setInitStyle(),r.fillText(t,s.x+7*a,s.y+1*a)}}}),D.Layer.Mask=D.Layer.extend({init:function(t,e){e=e||{},this._super(t,e),this._opacity=!!e.transparent&&e.transparent,this.oClass="maskLayer",this._actionRelations={},this._roi=[]},privateInitLayerContainer:function(t,e,i){var r=D.Util.createCanvas(t,e,i,!0);this._layerContainer=r,this._ctx=r.getContext("2d"),this._layerContainer.style.left="0",this._layerContainer.style.top="0"},onAdd:function(t){var e=(this._map=t).getSize(),i=this._map.getContainer();this.privateInitLayerContainer(this.id,e.w,e.h),i.appendChild(this._layerContainer),this.setzIndex(),this.setOpacity(this.options.opacity),this.oMaskActions=[]},addMaskAction:function(t,e){e&&(this.clear(),this.oMaskActions=[]),t instanceof Array?this.oMaskActions=[].concat(L(this.oMaskActions),L(t)):this.oMaskActions.push(t),this.updateMaskActionRelation(),this.draw()},updateMaskActionRelation:function(){for(var t=this.oMaskActions,e={},i={},r=0,n=t.length;r<n;r++){var o=t[r],s=o.key,a=o.type,l=o.name;if(("drawMask"===a||"imgMask"===a)&&!e[s]){for(var h=[],c=r+1;c<n;c++){var u=t[c],d=u.key,y=u.type,f=u.name;"drawMask"!==y&&"imgMask"!==y||!f||f!==l||(h.push(u),e[d]=1),"clearMask"===y&&h.push(u)}i[l||s]={targetAction:o,relatedMaskActions:h}}}this._actionRelations=i},renew:function(t){this._super(),this.clear(),"mouseWheel"===t?this.drawTimer():this.draw()},resize:function(){this._super();var t=D.Util.getDpr();this._layerContainer.width=this._map.w*t,this._layerContainer.height=this._map.h*t,this.renew()},clear:function(){var t=this.getLayerContainer();this._ctx.clearRect(0,0,t.width,t.height)},getAllMaskActions:function(){return this.oMaskActions},getCtx:function(){return this._ctx},setContextStyle:function(t){var e=t.lineWidth,i=void 0===e?0:e,r=t.color,n=void 0===r?"#333":r,o=t.fillColor,s=void 0===o?"#333":o,a=t.opacity,l=void 0===a?1:a,h=this._ctx,c=D.Util.getDpr();h.strokeStyle=n,h.fillStyle=s,h.lineWidth=i*c,h.globalAlpha=l,h.lineCap="round",h.lineJoin="round"},drawTimer:function(){this._drawTimer&&(clearTimeout(this._drawTimer),this._drawTimer=null);var t=this;this._drawTimer=setTimeout(function(){t.draw()},333)},draw:function(){var t=this._ctx;t.save(),this.drawRoi();for(var e=this.oMaskActions,i=0,r=e.length;i<r;i++){var n=e[i],o=n.type,s=n.segments,a=void 0===s?[]:s,l=n.image;switch(o){case"drawMask":this.drawMaskActionSegments(a);break;case"imgMask":this.drawMaskActionImg(l);case"clearMask":this.clearMaskActionSegments(a)}}t.restore()},drawMaskActionSegments:function(){for(var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],e=this._map,i=this._ctx,r=0,n=t.length;r<n;r++){var o=t[r],s=o.type,a=o.point,l=o.radius,h=o.points,c=void 0===h?[]:h,u=o.color,d=o.opacity,y=void 0===d?1:d;switch(this.setContextStyle({fillColor:u,color:u,lineWidth:0,opacity:y}),s){case"circle":var f=l*D.Util.worldToScreenDistance(e,1);D.Graph.drawGeoPoint(e,i,a,f);break;case"polygon":D.Graph.drawGeoPolygon(e,i,c,!0)}}},drawMaskActionImg:function(t){var e=t.width,i=t.height,r=this.getLayerContainer(),n=this.getImgMaskActionClipArea(e,i),o=n.x,s=n.y,a=n.width,l=n.height;this._ctx.drawImage(t,o,s,a,l,0,0,r.width,r.height)},getImgMaskActionClipArea:function(t,e){var i=this._map.zoom,r=this._map.getCenter(),n=this._map,o=n.w,s=i*n.h/o;return{x:t/2-i/2+r.x,y:e/2-s/2-r.y,width:i,height:s}},clearMaskActionSegments:function(){for(var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],e=0,i=t.length;e<i;e++){var r=t[e],n=r.type,o=r.point,s=r.radius,a=r.points,l=void 0===a?[]:a;switch(n){case"circle":this.clearMaskWithCircleSegment({point:o,radius:s});break;case"polygon":this.clearMaskWithPolygonSegment({points:l})}}},clearMaskWithCircleSegment:function(t){var e=t.point,i=t.radius,r=this._map,n=i*D.Util.worldToScreenDistance(r,1);this.clearMaskWithCircleSegmentInner({point:e,radius:n})},clearMaskWithCircleSegmentInner:function(t){var e=t.point,i=t.radius,r=this._map,n=this._ctx,o=this.getLayerContainer(),s=o.width,a=o.height,l=D.Util.getDpr();D.Graph.clearGeoArc(r,e,i*l,n,s,a)},clearMaskWithPolygonSegment:function(t){var e=t.points,i=void 0===e?[]:e,r=this._map,n=this._ctx,o=this.getLayerContainer(),s=o.width,a=o.height;D.Graph.clearGeoPolygon(r,i,n,s,a)},setRoi:function(t){this._roi=t,this.renew()},drawRoi:function(){var t=this._roi,e=this._map,i=this._ctx;!t||t.length<3||D.Graph.drawGeoRoi(e,t,i)},getMaskActionsWithPixels1:function(t,e){var i=this._actionRelations;for(var r in i){var n=i[r];D.worker.runWorker({method:D.worker.getMaskPixels,message:{workerSingle:"multiple",canvasSize:{width:t,height:e},actions:n},callback:function(t){console.log("来自子线程信息：hi，主人，我已经计算完成了"),console.log("res",t)}})}},getMaskActionsWithPixels2:function(t,e){var i=this._actionRelations,r=(new Date).getTime();D.worker.runWorker({method:D.worker.getMaskPixels,message:{workerSingle:"single",canvasSize:{width:t,height:e},actions:i},callback:function(t){console.log("来自子线程信息：hi，主人，我已经计算完成了");var e=(new Date).getTime()-r;console.log("计算耗时：",e)}})},getMaskActionsWithPixels:function(t,e){var i=this._actionRelations,r=this.getCanvas(t,e),n=r.getContext("2d"),o=(new Date).getTime(),s=[];for(var a in i){n.clearRect(0,0,t,e);var l=i[a];this.renderMaskWithActions(r,l);var h=this.getRlePixelData(r);s.push({pixels:h,key:a})}var c=(new Date).getTime()-o;return console.log("计算耗时：",c),console.log("result",s),s},getCanvas:function(t,e){var i=new OffscreenCanvas(t,e),r=i.getContext("2d");return r.fillStyle="#000000",r.strokeStyle="#000000",r.globalAlpha=1,i},renderMaskWithActions:function(t,e){var i=e.targetAction,r=e.relatedMaskActions,n=void 0===r?[]:r,o=i.type,s=i.segments,a=void 0===s?[]:s,l=i.image;"drawMask"===o&&this.renderDrawMaskSegments(t,a),"imgMask"===o&&this.renderImageMask(t,l);for(var h=0,c=n.length;h<c;h++){var u=n[h],d=u.type,y=u.segments,f=void 0===y?[]:y,p=u.image;"drawMask"===d&&this.renderDrawMaskSegments(t,f),"imgMask"===d&&this.renderImageMask(t,p),"clearMask"===d&&this.renderClearMaskSegments(t,f)}},renderDrawMaskSegments:function(t){for(var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],i=0,r=e.length;i<r;i++){var n=e[i];switch(n.type){case"circle":this.renderDrawMaskSegmentCircle(t,n);break;case"polygon":this.renderDrawMaskSegmentPolygon(t,n)}}},renderImageMask:function(t,e){t.getContext("2d").drawImage(e,0,0)},renderClearMaskSegments:function(t){for(var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],i=0,r=e.length;i<r;i++){var n=e[i];switch(n.type){case"circle":this.renderClearMaskSegmentCircle(t,n);break;case"polygon":this.renderClearMaskSegmentPolygon(t,n)}}},renderDrawMaskSegmentCircle:function(t,e){var i=t.getContext("2d"),r=t.width,n=t.height,o=e.point,s=e.radius,a={x:o.x+r/2,y:n/2-o.y};i.beginPath(),i.arc(a.x,a.y,s,0,2*Math.PI,!0),i.closePath(),i.fill()},renderDrawMaskSegmentPolygon:function(t,e){var i=t.getContext("2d"),r=t.width,n=t.height,o=e.points,s=void 0===o?[]:o,a=s.length;if(2<=a){i.beginPath();var l={x:s[0].x+r/2,y:n/2-s[0].y};i.moveTo(l.x,l.y);for(var h=1;h<a;h++){var c={x:s[h].x+r/2,y:n/2-s[h].y};i.lineTo(c.x,c.y)}i.closePath()}i.stroke(),i.fill()},renderClearMaskSegmentCircle:function(t,e){var i=t.getContext("2d"),r=t.width,n=t.height,o=e.point,s=e.radius,a={x:o.x+r/2,y:n/2-o.y};i.save(),i.beginPath(),i.arc(a.x,a.y,s,0,2*Math.PI),i.clip(),i.clearRect(0,0,r,n),i.restore()},renderClearMaskSegmentPolygon:function(t,e){var i=t.getContext("2d"),r=t.width,n=t.height,o=e.points,s=void 0===o?[]:o;i.save(),i.beginPath();var a=s.length;if(2<=a){i.beginPath();var l={x:s[0].x+r/2,y:n/2-s[0].y};i.moveTo(l.x,l.y);for(var h=1;h<a;h++){var c={x:s[h].x+r/2,y:n/2-s[h].y};i.lineTo(c.x,c.y)}i.closePath()}i.clip(),i.clearRect(0,0,r,n),i.restore()},getPixelData:function(t){for(var e=[],i=t.getContext("2d"),r=t.width,n=t.height,o=i.getImageData(0,0,r,n).data,s=0;s<n;s++)for(var a=0;a<r;a++){var l=4*(s*r+a),h=o[l],c=o[l+1],u=o[l+2],d=o[l+3];(h||c||u||d)&&e.push([s+1,a+1])}return e},getRlePixelData:function(t){for(var e=[],i=t.getContext("2d"),r=t.width,n=t.height,o=i.getImageData(0,0,r,n).data,s=0,a=1,l=0;l<n;l++)for(var h=0;h<r;h++){var c=4*(l*r+h),u=o[c],d=o[c+1],y=o[c+2],f=o[c+3],p=+!!(u||d||y||f);p===a?s++:(e.push(s),s=1),l+1===n&&h+1===r&&e.push(s),a=p}return console.log("--rlePixels--",e),e}}),D.Layer.Marker=D.Layer.extend({init:function(t,e){this._super(t,e),this.options=e||{opacity:1,zIndex:20},this.id=t,this.oClass="markerLayer",this.oMarkers=[]},privateInitLayerContainer:function(t,e,i){var r=D.Util.createDiv(t,e,i,!0);this._layerContainer=r},addMarker:function(t){D.Util.isInArray(this.oMarkers,t)||(this.oMarkers.push(t),t.onAdd(this))},removeMarker:function(t){for(var e=[],i=0,r=0;i<this.oMarkers.length;i++)this.oMarkers[i]!==t?(e[r]=this.oMarkers[i],r++):this.oMarkers[i].onRemove(this);this.oMarkers=e,this.renew()},removeMarkerById:function(t){for(var e=[],i=0,r=this.oMarkers.length;i<r;i++){var n=this.oMarkers[i];n.id!==t?e.push(n):n.onRemove(this)}this.oMarkers=e,this.renew()},removeMarkersByIds:function(t){for(var e=[],i=[],r=0,n=this.oMarkers.length;r<n;r++){var o=this.oMarkers[r];-1===t.indexOf(o.id)?e.push(o):(o.onRemove(this),i.push(o))}return this.oMarkers=e,this.renew(),i},getAllMarkers:function(){return this.oMarkers},getMarkerById:function(t){for(var e=0;e<this.oMarkers.length;e++)if(this.oMarkers[e].id===t)return this.oMarkers[e];return null},addMarkers:function(t){for(var e=0;e<t.length;e++)this.addMarker(t[e])},removeMarkers:function(t){for(var e=t,i=e.length,r=0;r<i;r++){var n=e[r];this.removeMarker(n)}},removeAllMarkers:function(){var t=this.oMarkers;this.removeMarkers(t)},renew:function(){this._super();for(var t=0;t<this.oMarkers.length;t++)this.oMarkers[t].renew()},resize:function(){this._super(),this.renew()}}),D.Layer.Text=D.Layer.extend({init:function(t,e){e=e||{opacity:1,zIndex:19},this._super(t,e),this.textStyle=e.style||new D.Style({}),this.editable=!0,this.oClass="textLayer",this.oTexts=[]},privateInitLayerContainer:function(t,e,i){var r=D.Util.createCanvas(t,e,i,!0);this._layerContainer=r,this._ctx=r.getContext("2d"),this._layerContainer.style.left="0",this._layerContainer.style.top="0"},addText:function(t){D.Util.isInArray(this.oTexts,t)||(this.oTexts.push(t),t.onAdd(this))},removeText:function(t){for(var e=[],i=0,r=0;i<this.oTexts.length;i++)this.oTexts[i]!==t?(e[r]=this.oTexts[i],r++):this.oTexts[i].onRemove(this);this.oTexts=e,this.renew()},getTextById:function(t){for(var e=0;e<this.oTexts.length;e++)if(this.oTexts[e].id===t)return this.oTexts[e];return null},removeTextById:function(t){for(var e=[],i=0,r=this.oTexts.length;i<r;i++){var n=this.oTexts[i];n.id!==t?e.push(n):n.onRemove(this)}this.oTexts=e,this.renew()},removeTextsByIds:function(t){for(var e=[],i=[],r=0,n=this.oTexts.length;r<n;r++){var o=this.oTexts[r];-1===t.indexOf(o.id)?e.push(o):(o.onRemove(this),i.push(o))}return this.oTexts=e,this.renew(),i},addTexts:function(t){for(var e=0;e<t.length;e++)this.addText(t[e])},removeTexts:function(t){for(var e=t,i=e.length,r=0;r<i;r++){var n=e[r];this.removeText(n)}},getAllTexts:function(){return this.oTexts},removeAllTexts:function(){this.oTexts=[],this.renew()},renew:function(t){this._super(),this.clear(),"mouseWheel"===t?this.drawTimer():this.draw()},drawTimer:function(){this._drawTimer&&(clearTimeout(this._drawTimer),this._drawTimer=null);var t=this;this._drawTimer=setTimeout(function(){t.draw()},333)},resize:function(){this._super();var t=D.Util.getDpr();this._layerContainer.width=this._map.w*t,this._layerContainer.height=this._map.h*t,this.renew()},clear:function(){var t=this.getLayerContainer();this._ctx.clearRect(0,0,t.width,t.height)},getCtx:function(){return this._ctx},draw:function(){for(var t=this.getAllTexts(),e=0,i=t.length;e<i;e++)t[e].onDraw(this)}}),D.Layer.Text2=D.Layer.extend({init:function(t,e){this._super(t,e),this.options=e||{opacity:1,zIndex:19},this.id=t,this.oClass="textLayer",this.oTexts=[]},privateInitLayerContainer:function(t,e,i){var r=D.Util.createDiv(t,e,i,!0);this._layerContainer=r},addText:function(t){D.Util.isInArray(this.oTexts,t)||(this.oTexts.push(t),t.onAdd(this))},removeText:function(t){for(var e=[],i=0,r=0;i<this.oTexts.length;i++)this.oTexts[i]!==t?(e[r]=this.oTexts[i],r++):this.oTexts[i].onRemove(this);this.oTexts=e,this.renew()},getTextById:function(t){for(var e=0;e<this.oTexts.length;e++)if(this.oTexts[e].id===t)return this.oTexts[e];return null},removeTextById:function(t){for(var e=[],i=0,r=this.oTexts.length;i<r;i++){var n=this.oTexts[i];n.id!==t?e.push(n):n.onRemove(this)}this.oTexts=e,this.renew()},removeTextsByIds:function(t){for(var e=[],i=[],r=0,n=this.oTexts.length;r<n;r++){var o=this.oTexts[r];-1===t.indexOf(o.id)?e.push(o):(o.onRemove(this),i.push(o))}return this.oTexts=e,this.renew(),i},addTexts:function(t){for(var e=0;e<t.length;e++)this.addText(t[e])},removeTexts:function(t){for(var e=t,i=e.length,r=0;r<i;r++){var n=e[r];this.removeText(n)}},getAllTexts:function(){return this.oTexts},removeAllTexts:function(){this._layerContainer.innerHTML="",this.oTexts=[],this.renew()},renew:function(){this._super();for(var t=0;t<this.oTexts.length;t++)this.oTexts[t].renew()},resize:function(){this._super(),this.renew()}}),D.Layer.Roi=D.Layer.extend({init:function(t,e){e=e||{opacity:1,zIndex:2},this._super(t,e),this.roiStyle=e.style||new D.Style({});var i=new Image;i.src=D.constants.textureIcon,this.imageTexture=i,this.editable=!0,this.oClass="roiLayer",this.roiAreas=[]},setEditable:function(t){this.editable=!!t},privateInitLayerContainer:function(t,e,i){var r=D.Util.createCanvas(t,e,i,!0);this._layerContainer=r,this._ctx=r.getContext("2d"),this._layerContainer.style.left=0,this._layerContainer.style.top=0},addFeature:function(t){var e=!0;t.onAdd(this);var i=D.Util.roiAreasOrderByLevel(this.roiAreas);if(i.length){var r=this.getParentRoiArea(i,t);if(!r)return;if(r.children&&r.children.length)for(var n=0;n<r.children.length;n++)if(D.Util.polygonCross(r.children[n].points,t.points)){e=!1;break}e&&t&&this.updateRoiAreas(this.roiAreas,r,t)}else this.roiAreas.push(t);return e&&this.renew(),e},getParentRoiArea:function(t,e){var i;if(!t.length)return null;for(var r=0;r<t.length;r++)if(t[r].roiType!==e.roiType&&D.Util.polygonInPolygon(e.points,t[r].points)){i=t[r];break}return i},updateRoiAreas:function(t,e,i){for(var r=0;r<t.length;r++){if(e.id===t[r].id){t[r].children?t[r].children.push(i):t[r].children=[i];break}t[r].children&&this.updateRoiAreas(t[r].children,e,i)}},getAllRoiAreas:function(){return this.roiAreas||[]},renew:function(){var e=this;this._super(),this.clear(),this.roiAreas.forEach(function(t){return e.draw(t)})},draw:function(t){var e=this,i=this._ctx,r=t.gStyle,n=D.Util.getDpr();if(D.Util.setStyle(i,r),t.hoverStatus&&!t.activeStatus&&(i.lineWidth=2*r.lineWeight*n),t.activeStatus){var o=t.activeStyle.strokeColor;i.strokeStyle=o}i.setLineDash([]),i.globalAlpha=1,i.beginPath();var s=t.points.length,a=D.Util.worldToScreen(this._map,t.points[0].x,t.points[0].y),l=D.Util.transformScreenXYWithDpr(a);i.moveTo(l.x,l.y);for(var h=1;h<s;h++)a=D.Util.worldToScreen(this._map,t.points[h].x,t.points[h].y),l=D.Util.transformScreenXYWithDpr(a),i.lineTo(l.x,l.y);i.closePath(),i.stroke();var c=i.createPattern(this.imageTexture,"repeat");i.strokeStyle=c,i.fillStyle=c,i.fill(),"roi"===t.roiType&&D.Graph.clearGeoPolygon(this._map,t.points,i,this._layerContainer.width,this._layerContainer.height),t.children&&t.children.forEach(function(t){return e.draw(t)}),t.setVerticesActiveStatus(this)},clear:function(){var t=this.getLayerContainer();this._ctx.clearRect(0,0,t.width,t.height)},removeAllRois:function(){this.roiAreas=[],this.renew()},getFeaturesWithPos:function(t,e){if(!this.editable)return[];for(var i=[],r=this.getAllRoiAreas(),n=D.Util.roiAreasOrderByLevel(r),o=0;o<n.length-1;o++){var s=n[o],a=!0;e&&"active"===e&&(a=s.activeStatus),e&&"hover"===e&&(a=!0),s.isCaught(t)&&a&&i.push(s)}return i},resetFeatureStatus:function(n){var t=this.getAllRoiAreas(),o=!1;return function t(e){for(var i=0;i<e.length;i++){var r=e[i];n&&"active"===n?r.activeStatus&&(r.activeStatus=!1,o=!0):n&&"hover"===n?r.hoverStatus&&(r.hoverStatus=!1,o=!0):(r.activeStatus||r.hoverStatus)&&(r.activeStatus=!1,r.hoverStatus=!1,o=!0),r.children&&t(r.children)}}(t),o&&this.renew(),o},resize:function(){this._super();var t=D.Util.getDpr();this._layerContainer.width=this._map.w*t,this._layerContainer.height=this._map.h*t,this.renew()},catchFeaturePointWithPos:function(t,e){for(var i=[],r=this.getAllRoiAreas(),n=D.Util.roiAreasOrderByLevel(r),o=n.length-1;0<=o;o--){var s=n[o],a=!0;e&&"active"===e&&(a=s.activeStatus);var l=s.catchPointWithPos(this,t);l.flag&&a&&i.push({feature:s,point:l.point})}return i},validateFeatureWithNewPoints:function(t,e){var i=this.roiAreas,r=D.Util.getParent(i,t),n=r[r.length-1],o=n.points,s=e;return D.Util.polygonInPolygon(s,o)&&!D.Util.polygonCrossWithParentChildren(t,n,e)&&D.Util.childrenInCurrentPolygon(e,t)}}),D.Control=o.extend({init:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i=(new Date).getTime()+"";this.id=t||i,this._controlContainer=this.generateContainer(),this._controlContainer.id=t,this.setControlContainerPosition(e)},setControlContainerPosition:function(t){this._postion=t.postion||t.pos||{right:0,bottom:0};var e=this._postion,i=e.left,r=e.top,n=e.right,o=e.bottom;this._controlContainer.style.position="absolute",this._controlContainer.style.display="inline-block",this._controlContainer.style.zIndex=999999,!isNaN(i)&&(this._controlContainer.style.left=i+"px"),isNaN(i)&&(this._controlContainer.style.left="auto"),!isNaN(r)&&(this._controlContainer.style.top=r+"px"),isNaN(r)&&(this._controlContainer.style.top="auto"),!isNaN(n)&&(this._controlContainer.style.right=n+"px"),isNaN(n)&&(this._controlContainer.style.right="auto"),!isNaN(o)&&(this._controlContainer.style.bottom=o+"px"),isNaN(o)&&(this._controlContainer.style.bottom="auto")},generateContainer:function(){return document.createElement("div")},setVisible:function(t){this.visible=t,this.refresh&&this.refresh()},show:function(){this.visible||this.setVisible(!0)},hide:function(){this.visible&&this.setVisible(!1)},onAdd:function(t){this._map=t,this.visible=!0;var e=this.selfContainer||this.getMapContainer();if(!e||!this._controlContainer)return!1;this.selfContainer&&(this._controlContainer.style.position="relative"),e.appendChild(this._controlContainer)},onRemove:function(){var t=this.selfContainer||this.getMapContainer();if(!t||!this._controlContainer)return!1;try{t.removeChild(this._controlContainer)}catch(t){console.log("ailabel-control-removechild-error")}},getMapContainer:function(){return this._map?this._map.getContainer():null},getMapContainerSize:function(){return this._map?{w:this._map.w,h:this._map.h}:null},getMapZoomScale:function(){var t=this.getMapContainer(),e=this.getMapZoom(),i=(this.getMapContainerSize()||{}).w;return!!(t&&e&&i)&&e/i},getMapZoom:function(){if(this._map)return this._map.getZoom()},getMapHZoom:function(){var t=this.getMapZoomScale(),e=this.getMapContainerSize();if(t&&e)return t*e.h},getContainerInfo:function(){this._map},boundsWatch:function(){},resize:function(){this.refresh()},refresh:function(){this.onDraw()}}),D.Control.Scale=D.Control.extend({init:function(t,e){var i=e||{};this._super(t,i),this._style=i.style||new D.Style({opacity:0}),this.type="scale"},onAdd:function(t){this._super(t),this.setContainerProps(),this.onDraw(t)},onDraw:function(){var t=this.getMapZoomScale();t&&this.setScaleContent(t)},setContainerProps:function(){if(!this._controlContainer)return console.warn("controlContainer不存在：setContainerProps:function"),!1;var t=this._style;this._controlContainer.style.fontSize=t.fontSize+"px",this._controlContainer.style.fontFamily=t.fontFamily+",SimSun",this._controlContainer.style.color=t.fontColor,this._controlContainer.style.padding="2px";var e=t.opacity||0===t.opacity?t.opacity:1,i=D.Util.colorRgb(t.bgColor,e);this._controlContainer.style.background=i},setScaleContent:function(t){if(!this._controlContainer)return console.warn("controlContainer不存在：setScaleContent:function"),!1;var e=parseInt(100*t,10)+"/100";this._controlContainer.textContent=e||"--/--"},boundsWatch:function(){this._super(),this.onDraw()}}),D.Control.EagleMap=D.Control.extend({init:function(t,e){var i=e||{};this._super(t,i),this.type="eagleMap",this._image=i.image||{src:"",width:0,height:0},this._imageId="image-"+t,this._size=i.size||{width:200,height:150},this._type=-1<["default","grid"].indexOf(i.type)?i.type:"default",this._activeGridElement=null,i.container&&document.getElementById(i.container)&&(this.selfContainer=document.getElementById(i.container)),this._controlContainerBorderWidth=1,this._controlContainerProps=function(n){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{},e=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&(e=e.concat(Object.getOwnPropertySymbols(o).filter(function(t){return Object.getOwnPropertyDescriptor(o,t).enumerable}))),e.forEach(function(t){var e,i,r;e=n,r=o[i=t],i in e?Object.defineProperty(e,i,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[i]=r})}return n}({display:"-webkit-box",webkitBoxPack:"center",webkitBoxAlign:"center",boxSizing:"border-box",borderRadius:"0",overflow:"hidden",zIndex:999999,border:this._controlContainerBorderWidth+"px solid #eaeaea"},"grid"===this._type?{backgroundColor:"#000"}:{}),this._highlightProps={border:"2px solid #ff0000",borderRadius:"2px",position:"absolute",boxSizing:"border-box",left:0,top:0,width:0,height:0},this._gridConfig=!!i.grid&&Object.assign({},{rowCount:3,columnCount:3,color:"#000"},i.grid),this._gridProps={position:"absolute",left:"50%",top:"50%",width:0,height:0};var r=this._gridConfig||{},n=r.columnCount,o=void 0===n?1:n,s=r.rowCount,a=void 0===s?1:s,l=r.color,h=void 0===l?"#000":l;this._gridCellProps="default"===this._type?{display:"flex",alignItems:"center",justifyContent:"center",position:"relative",boxSizing:"border-box",float:"left",border:"0 solid "+h,cursor:"pointer",width:100/o+"%",height:100/a+"%",borderRightWidth:"1px",borderBottomWidth:"1px"}:{display:"flex",alignItems:"center",justifyContent:"center",position:"relative",boxSizing:"border-box",float:"left",border:"0 solid "+h,cursor:"pointer",width:100/o+"%",height:100/a+"%",borderRightWidth:"2px",borderBottomWidth:"2px",backgroundColor:"rgba(255, 255, 255, .2)"}},onAdd:function(t){this.selfContainer&&(this.selfContainer.innerHTML=""),this._super(t),this.setContainerProps(),this.setPropsRelatedWithImageInfo(),"default"===this._type&&(this.addImage(),this.addHighlightRect()),this.addGrid(),this.onDraw(t)},setPropsRelatedWithImageInfo:function(){var t=this._image,e=t.width,i=t.height,r=this._size,n=r.width,o=r.height;this._zoom=n/o<=e/i?(this._imageScreenWidth=n,this._imageScreenHeight=i*n/e,e):(this._imageScreenWidth=e*o/i,this._imageScreenHeight=o,e*n/this._imageScreenWidth)},addImage:function(){var t=this._image,e=t.src,i=t.width,r=t.height,n=this._size,o=n.width,s=n.height;this._mapImg=document.createElement("img"),this._mapImg.id=this._imageId,this._mapImg.src=e,o/s<=i/r?this._mapImg.style.width="100%":this._mapImg.style.height="100%",this._mapImg.style.display="block",this._mapImg.style.margin="0 auto",this._controlContainer.appendChild(this._mapImg)},addHighlightRect:function(){for(var t in this._highlight=document.createElement("div"),this._highlightProps)this._highlight.style[t]=this._highlightProps[t];this._controlContainer.appendChild(this._highlight)},changeHighlightRectSize:function(t,e){if(!this._highlight)return!1;this._highlight.style.width=t+"px",this._highlight.style.height=e+"px"},changeHighlightRectPosition:function(t,e){if(!this._highlight)return!1;var i=-this._controlContainerBorderWidth;this._highlight.style.left=t+i+"px",this._highlight.style.top=e+i+"px"},addGrid:function(){var t=this._imageScreenWidth,e=this._imageScreenHeight;if(this._grid=document.createElement("div"),this._grid.className="ailabel-control-eagle-map-grid","default"===this._type){if(!this._gridConfig||!t||!e)return;this._gridProps.width=t+"px",this._gridProps.height=e+"px",this._gridProps.marginLeft=-t/2+"px",this._gridProps.marginTop=-e/2+"px"}else{if(!this._gridConfig)return;this._gridProps.width="100%",this._gridProps.height="100%",this._gridProps.left=0,this._gridProps.top=0}for(var i in this._gridProps)this._grid.style[i]=this._gridProps[i];for(var r=this._gridConfig,n=r.columnCount,o=r.rowCount,s=0;s<o;s++)for(var a=0;a<n;a++){var l=document.createElement("div");for(var h in this._gridCellProps)l.style[h]=this._gridCellProps[h];a+1===n&&(l.style.borderRightWidth=0),s+1===o&&(l.style.borderBottomWidth=0),"grid"===this._type&&(l.innerHTML='<svg t="1573368358416" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7399" width="80%" height="80%"><path d="M289 802.2l190.7-190.7-67.9-67.9-186.1 186.1V571l-96 0.1v327l0.1 0.1 327 0.1v-96l-167.8-0.1z m-63.3-2.6l2.6 2.6h-2.6v-2.6z m671.2-671.2l-327.1 0.1v95.8l161.2 0.1-189.7 189.7 67.9 67.9L801 290.2v165.3l95.9 0.1V128.5z" fill="#fff" p-id="7400"></path></svg>'),l.setAttribute("data-row",s+1),l.setAttribute("data-column",a+1),this.bindGridCellHoverStyle(l),this.bindGridCellEvent(l),this._grid.appendChild(l)}this._controlContainer.appendChild(this._grid)},bindGridCellHoverStyle:function(t){var e=this;t.onmouseover=function(){"default"===e._type&&(this.style.boxShadow="0 2px 2px gray")},t.onmouseout=function(){"default"===e._type&&(this.style.boxShadow="none")}},bindGridCellEvent:function(t){var d=this,e=d.getMapZoom(),y=d.getMapContainerSize();d._map&&e&&y&&(t.onclick=function(){var t=1*this.getAttribute("data-row"),e=1*this.getAttribute("data-column"),i=d.getGridCellCenter(t,e),r=i.x,n=i.y,o=y.w,s=y.h,a=d.getGridCellWordWidthAndHeight(),l=a.width,h=a.height,c=o/s<=l/h?1.2*l:o/s*h*1.2;if(d._map.centerAndZoom({x:r,y:n},c),"grid"===d._type){this.style.backgroundColor="rgba(16,140,238,.2)",d._activeGridElement&&(d._activeGridElement.style.border=""),(d._activeGridElement=this).style.border="1px solid red";var u=this.querySelector("svg path");u&&(u.style.fill="#108CEE")}})},getGridCellCenter:function(t,e){var i=this._gridConfig||{},r=i.columnCount,n=void 0===r?1:r,o=i.rowCount,s=void 0===o?1:o,a=this.getGridCellWordWidthAndHeight(),l=a.width,h=a.height;return{x:(e-n/2)*l-l/2,y:(s/2-t)*h+h/2}},getGridCellWordWidthAndHeight:function(){var t=this.getGridCellScreenWidthAndHeight(),e=t.width,i=t.height,r=this.getEagleMapScale();return{width:r*e,height:r*i}},getGridCellScreenWidthAndHeight:function(){var t=this._gridConfig||{},e=t.columnCount,i=void 0===e?1:e,r=t.rowCount,n=void 0===r?1:r;return{width:this._imageScreenWidth/i,height:this._imageScreenHeight/n}},onDraw:function(){var t=this.getMapZoom(),e=this.getMapHZoom(),i=this.getEagleMapScale();if(!t||!e||!i)return!1;var r=parseInt(t/i,10),n=parseInt(e/i,10);this.changeHighlightRectSize(r,n);var o=this.getLeftTopWordPosition();this.changeHighlightRectPosition(o.x,o.y)},getEagleMapScale:function(){var t=this._size.width;return this._zoom/t},setContainerProps:function(){if(!this._controlContainer)return console.warn("controlContainer不存在：setContainerProps:function"),!1;for(var t in this._controlContainer.onclick=function(t){t.stopPropagation(),t.cancelBubble=!0},this._controlContainerProps)this._controlContainer.style[t]=this._controlContainerProps[t];this._controlContainer.style.width=this._size.width+"px",this._controlContainer.style.height=this._size.height+"px"},getLeftTopWordPosition:function(){var t=D.Util.screenToWorld(this._map,0,0),e=this._size,i=e.width,r=e.height,n=this.getEagleMapScale(),o=parseInt(i,10)/2,s=parseInt(r,10)/2;return{x:parseFloat(o)+parseFloat((t.x-0)/n)+0,y:parseFloat(s)-parseFloat((t.y-0)/n)+0}},boundsWatch:function(){this._super(),this.onDraw(),this._activeGridElement&&(this._activeGridElement.style.border="")}}),D});